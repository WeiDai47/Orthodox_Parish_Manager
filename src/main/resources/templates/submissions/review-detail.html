<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Submission Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <style>
        .comparison-table { margin-top: 20px; }
        .comparison-table th { background-color: var(--accent-gold); color: black; }
        .changed { background-color: rgba(212, 175, 55, 0.2); }
        .field-label { font-weight: bold; color: var(--accent-gold); }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="text-gold fw-bold">Review Submission</h1>
            </div>
            <div class="col-md-4 text-end">
                <a href="/submissions/review" class="btn btn-outline-secondary">Back to List</a>
            </div>
        </div>

        <div class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-info-circle"></i> Submission Details
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><span class="field-label">Type:</span>
                            <span th:if="${submission.submissionType.name() == 'NEW'}" class="badge bg-info">NEW PARISHIONER</span>
                            <span th:unless="${submission.submissionType.name() == 'NEW'}" class="badge bg-warning">UPDATE REQUEST</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><span class="field-label">Status:</span>
                            <span th:if="${submission.status.name() == 'PENDING'}" class="badge bg-warning">PENDING</span>
                            <span th:if="${submission.status.name() == 'APPROVED'}" class="badge bg-success">APPROVED</span>
                            <span th:if="${submission.status.name() == 'REJECTED'}" class="badge bg-danger">REJECTED</span>
                        </p>
                    </div>
                </div>
                <p><span class="field-label">Submitted:</span> <span th:text="${#temporals.format(submission.submittedAt, 'MMMM dd, yyyy HH:mm')}"></span></p>
                <div th:if="${submission.reviewedAt != null}">
                    <p><span class="field-label">Reviewed:</span> <span th:text="${#temporals.format(submission.reviewedAt, 'MMMM dd, yyyy HH:mm')}"></span> by <span th:text="${submission.reviewedBy}"></span></p>
                </div>
                <div th:if="${submission.reviewNotes != null}">
                    <p><span class="field-label">Notes:</span> <span th:text="${submission.reviewNotes}"></span></p>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: SELECT TARGET PARISHIONER -->
        <div th:if="${isUpdate}" class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-search"></i> Select Parishioner to Update
            </div>
            <div class="card-body">
                <p class="text-muted">The person submitted: <strong th:text="${submission.firstName + ' ' + submission.lastName}"></strong></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Manually select which parishioner this update applies to, or leave blank to create as a new record.
                </div>
                <div class="mb-3">
                    <label for="targetParishionerSelect" class="form-label text-gold">Select Parishioner to Update:</label>
                    <select id="targetParishionerSelect" name="targetParishionerId" class="form-select">
                        <option value="">-- Create as new parishioner --</option>
                        <option th:each="p : ${allParishioners}" th:value="${p.id}" th:text="${p.firstName + ' ' + p.lastName}" th:selected="${currentParishioner != null && currentParishioner.id == p.id}"></option>
                    </select>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: SIDE-BY-SIDE COMPARISON (shown if target selected) -->
        <div th:if="${isUpdate && currentParishioner != null}" class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-arrow-left-right"></i> Current Data vs. Submitted Changes
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered comparison-table table-sm">
                        <thead>
                            <tr>
                                <th>Field</th>
                                <th style="width: 35%;">Current Value</th>
                                <th style="width: 35%;">Submitted Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- BASIC INFORMATION -->
                            <tr>
                                <td><strong>First Name</strong></td>
                                <td th:text="${currentParishioner.firstName}"></td>
                                <td th:classappend="${currentParishioner.firstName != submission.firstName ? 'changed' : ''}">
                                    <span th:text="${submission.firstName}"></span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Last Name</strong></td>
                                <td th:text="${currentParishioner.lastName}"></td>
                                <td th:classappend="${currentParishioner.lastName != submission.lastName ? 'changed' : ''}">
                                    <span th:text="${submission.lastName}"></span>
                                </td>
                            </tr>
                            <tr th:if="${submission.nameSuffix != null}">
                                <td>Name Suffix</td>
                                <td th:text="${currentParishioner.nameSuffix}"></td>
                                <td th:classappend="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '') ? 'changed' : ''}">
                                    <span th:text="${submission.nameSuffix}"></span>
                                </td>
                            </tr>
                            <tr th:if="${submission.birthday != null}">
                                <td>Birthday</td>
                                <td th:text="${currentParishioner.birthday != null ? #temporals.format(currentParishioner.birthday, 'MMMM dd, yyyy') : 'Not provided'}"></td>
                                <td th:classappend="${(currentParishioner.birthday != null ? currentParishioner.birthday : '') != (submission.birthday != null ? submission.birthday : '') ? 'changed' : ''}">
                                    <span th:text="${submission.birthday != null ? #temporals.format(submission.birthday, 'MMMM dd, yyyy') : 'Not provided'}"></span>
                                </td>
                            </tr>

                            <!-- CONTACT INFORMATION -->
                            <tr>
                                <td>Email</td>
                                <td th:text="${currentParishioner.email != null ? currentParishioner.email : '(not set)'}"></td>
                                <td th:classappend="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '') ? 'changed' : ''}">
                                    <span th:text="${submission.email != null ? submission.email : '(not set)'}"></span>
                                </td>
                            </tr>
                            <tr>
                                <td>Phone</td>
                                <td th:text="${currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '(not set)'}"></td>
                                <td th:classappend="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '') ? 'changed' : ''}">
                                    <span th:text="${submission.phoneNumber != null ? submission.phoneNumber : '(not set)'}"></span>
                                </td>
                            </tr>

                            <!-- MEMBERSHIP STATUS -->
                            <tr>
                                <td>Membership Status</td>
                                <td th:text="${currentParishioner.status != null ? currentParishioner.status : '(not set)'}"></td>
                                <td th:classappend="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '') ? 'changed' : ''}">
                                    <span th:text="${submission.membershipStatus != null ? submission.membershipStatus : '(not set)'}"></span>
                                </td>
                            </tr>

                            <!-- MARITAL STATUS -->
                            <tr th:if="${submission.maritalStatus != null}">
                                <td>Marital Status</td>
                                <td th:text="${currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '(not set)'}"></td>
                                <td th:classappend="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '') ? 'changed' : ''}">
                                    <span th:text="${submission.maritalStatus != null ? submission.maritalStatus : '(not set)'}"></span>
                                </td>
                            </tr>

                            <!-- ORTHODOX INFORMATION -->
                            <tr th:if="${submission.isOrthodox}">
                                <td>Baptismal Name</td>
                                <td th:text="${currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '(not set)'}"></td>
                                <td th:classappend="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '') ? 'changed' : ''}">
                                    <span th:text="${submission.baptismalName != null ? submission.baptismalName : '(not set)'}"></span>
                                </td>
                            </tr>
                            <tr th:if="${submission.isOrthodox}">
                                <td>Patron Saint</td>
                                <td th:text="${currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '(not set)'}"></td>
                                <td th:classappend="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '') ? 'changed' : ''}">
                                    <span th:text="${submission.patronSaint != null ? submission.patronSaint : '(not set)'}"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NEW SUBMISSION: FULL DATA DISPLAY -->
        <div th:unless="${isUpdate}" class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-file-earmark-text"></i> Submitted Information
            </div>
            <div class="card-body">
                <!-- BASIC INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-gold fw-bold mb-3">Basic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">First Name:</span> <span th:text="${submission.firstName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">Last Name:</span> <span th:text="${submission.lastName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.nameSuffix != null}">
                            <p><span class="field-label">Name Suffix:</span> <span th:text="${submission.nameSuffix}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.birthday != null}">
                            <p><span class="field-label">Birthday:</span> <span th:text="${#temporals.format(submission.birthday, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">Membership Status:</span> <span th:text="${submission.membershipStatus}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- CONTACT INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-gold fw-bold mb-3">Contact Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.email != null}">
                            <p><span class="field-label">Email:</span> <span th:text="${submission.email}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.phoneNumber != null}">
                            <p><span class="field-label">Phone:</span> <span th:text="${submission.phoneNumber}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ADDRESS -->
                <div class="mb-4" th:if="${submission.address != null or submission.city != null}">
                    <h6 class="text-gold fw-bold mb-3">Address</h6>
                    <div class="row">
                        <div class="col-md-12 mb-2" th:if="${submission.address != null}">
                            <p><span class="field-label">Street:</span> <span th:text="${submission.address}"></span></p>
                        </div>
                        <div class="col-md-12 mb-2" th:if="${submission.city != null}">
                            <p><span class="field-label">City:</span> <span th:text="${submission.city}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- MARITAL STATUS -->
                <div class="mb-4" th:if="${submission.maritalStatus != null}">
                    <h6 class="text-gold fw-bold mb-3">Marital Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">Marital Status:</span> <span th:text="${submission.maritalStatus}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.marriageDate != null}">
                            <p><span class="field-label">Marriage Date:</span> <span th:text="${#temporals.format(submission.marriageDate, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- RELATIONSHIPS -->
                <div class="mb-4" th:if="${submission.manualSpouseName != null or submission.manualGodfatherName != null or submission.manualGodmotherName != null or submission.manualSponsorName != null}">
                    <h6 class="text-gold fw-bold mb-3">Relationships (Manual Entry)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.manualSpouseName != null}">
                            <p><span class="field-label">Spouse:</span> <span th:text="${submission.manualSpouseName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.manualGodfatherName != null}">
                            <p><span class="field-label">Godfather:</span> <span th:text="${submission.manualGodfatherName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.manualGodmotherName != null}">
                            <p><span class="field-label">Godmother:</span> <span th:text="${submission.manualGodmotherName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.manualSponsorName != null}">
                            <p><span class="field-label">Sponsor:</span> <span th:text="${submission.manualSponsorName}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- SPOUSE CREATION INFORMATION -->
                <div class="mb-4" th:if="${submission.spouseFirstName != null or submission.spouseLastName != null or submission.spouseEmail != null or submission.spousePhoneNumber != null}">
                    <h6 class="text-gold fw-bold mb-3">New Spouse Information (To Create)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.spouseFirstName != null}">
                            <p><span class="field-label">Spouse First Name:</span> <span th:text="${submission.spouseFirstName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spouseLastName != null}">
                            <p><span class="field-label">Spouse Last Name:</span> <span th:text="${submission.spouseLastName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spouseEmail != null}">
                            <p><span class="field-label">Spouse Email:</span> <span th:text="${submission.spouseEmail}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spousePhoneNumber != null}">
                            <p><span class="field-label">Spouse Phone:</span> <span th:text="${submission.spousePhoneNumber}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ORTHODOX INFORMATION -->
                <div class="mb-4" th:if="${submission.isOrthodox}">
                    <h6 class="text-gold fw-bold mb-3">Orthodox Church Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.baptismalName != null}">
                            <p><span class="field-label">Baptismal Name:</span> <span th:text="${submission.baptismalName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.patronSaint != null}">
                            <p><span class="field-label">Patron Saint:</span> <span th:text="${submission.patronSaint}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.baptismDate != null}">
                            <p><span class="field-label">Baptism Date:</span> <span th:text="${#temporals.format(submission.baptismDate, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.chrismationDate != null}">
                            <p><span class="field-label">Chrismation Date:</span> <span th:text="${#temporals.format(submission.chrismationDate, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- CHILDREN -->
                <div class="mb-4" th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                    <h6 class="text-gold fw-bold mb-3">Children</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr style="background-color: var(--accent-gold); color: black;">
                                            <th>Child Name</th>
                                            <th>Birthday</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="child : ${submission.childrenList}">
                                            <td th:text="${child.name}"></td>
                                            <td th:text="${child.birthday != null ? #temporals.format(child.birthday, 'MMMM dd, yyyy') : 'Not provided'}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APPROVAL/REJECTION ACTIONS -->
        <div th:if="${submission.status.name() == 'PENDING'}" class="row">
            <div class="col-md-6">
                <form id="approveForm" th:action="@{/submissions/review/{id}/approve(id=${submission.id})}" method="post" class="card bg-success border-0">
                    <div class="card-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="approveTargetParishionerId" name="targetParishionerId" value="" />
                        <button type="submit" class="btn btn-success w-100 fw-bold">
                            <i class="bi bi-check-circle"></i> Approve & Create/Update
                        </button>
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <form id="rejectForm" th:action="@{/submissions/review/{id}/reject(id=${submission.id})}" method="post" class="card bg-danger border-0">
                    <div class="card-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="rejectTargetParishionerId" name="targetParishionerId" value="" />
                        <textarea name="rejectionNotes" class="form-control form-control-sm mb-2" placeholder="Reason for rejection (optional)"></textarea>
                        <button type="submit" class="btn btn-danger w-100 fw-bold">
                            <i class="bi bi-x-circle"></i> Reject
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-3">
            <a href="/submissions/review" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const submissionId = window.location.pathname.split('/').pop();
        const approveForm = document.getElementById('approveForm');
        const rejectForm = document.getElementById('rejectForm');
        const targetParishionerSelect = document.getElementById('targetParishionerSelect');

        // Get CSRF token from meta tags or from hidden input in approve form
        function getCsrfToken() {
            const token = document.querySelector('meta[name="_csrf"]');
            if (token) return token.getAttribute('content');

            // Fallback: get from hidden input in any form
            const csrfInput = document.querySelector('input[name="_csrf"]');
            if (csrfInput) return csrfInput.value;

            return '';
        }

        function getCsrfHeader() {
            const header = document.querySelector('meta[name="_csrf_header"]');
            if (header) return header.getAttribute('content');
            return 'X-CSRF-TOKEN';
        }

        // When parishioner is selected, reload page with that parishioner loaded
        if (targetParishionerSelect) {
            targetParishionerSelect.addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    // Reload page - the controller will load the selected parishioner
                    // We pass it via a hidden form submission that will load it
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/submissions/review/' + submissionId + '/load-parishioner';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'targetParishionerId';
                    input.value = selectedId;
                    form.appendChild(input);

                    // Add CSRF token
                    const csrfToken = getCsrfToken();
                    const csrfHeader = getCsrfHeader();
                    if (csrfToken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = csrfHeader === 'X-CSRF-TOKEN' ? '_csrf' : csrfHeader;
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // Populate target parishioner ID when forms are submitted
        if (approveForm && targetParishionerSelect) {
            approveForm.addEventListener('submit', function() {
                document.getElementById('approveTargetParishionerId').value = targetParishionerSelect.value;
            });
        }

        if (rejectForm && targetParishionerSelect) {
            rejectForm.addEventListener('submit', function() {
                document.getElementById('rejectTargetParishionerId').value = targetParishionerSelect.value;
            });
        }
    </script>
</body>
</html>
