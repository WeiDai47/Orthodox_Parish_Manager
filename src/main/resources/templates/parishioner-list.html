<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parishioner Directory - Orthodox Parish Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/theme.css">
    <script src="/js/theme-toggle.js"></script>
    <style>
        .search-section { margin-bottom: 1.5rem; }
        @media print { .btn, .input-group, .dropdown, .navbar, .search-section { display: none !important; } }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
            <i class="bi bi-building"></i> Orthodox Parish Manager
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="/parishioners">Directory</a></li>
                <li class="nav-item" sec:authorize="hasAnyRole('PRIEST','SECRETARY')">
                    <a class="nav-link" href="/parishioners/add">Add Member</a>
                </li>
                <li class="nav-item" sec:authorize="hasAnyRole('PRIEST','SECRETARY')">
                    <a class="nav-link" href="/links"><i class="bi bi-link-45deg"></i> Links</a>
                </li>
                <li class="nav-item" sec:authorize="hasAnyRole('PRIEST','SECRETARY')">
                    <a class="nav-link" href="/submissions/review"><i class="bi bi-inbox"></i> Submissions</a>
                </li>
                <li class="nav-item" sec:authorize="hasAnyRole('PRIEST','SECRETARY')">
                    <a class="nav-link" href="/gmail"><i class="bi bi-envelope"></i> Email</a>
                </li>
                <li class="nav-item"><a class="nav-link" href="/settings"><i class="bi bi-gear"></i> Settings</a></li>
                <li class="nav-item" sec:authorize="hasRole('PRIEST')">
                    <a class="nav-link" href="/admin/users"><i class="bi bi-people"></i> Users</a>
                </li>
                <li class="nav-item">
                    <form action="/logout" method="POST" class="d-inline">
                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                        <button type="submit" class="btn btn-logout ms-2">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </button>
                    </form>
                </li>
                <li class="nav-item">
                    <button id="themeToggle" class="theme-toggle" title="Toggle theme">
                        <i class="bi bi-sun-fill sun-icon"></i>
                        <i class="bi bi-moon-fill moon-icon"></i>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 text-primary-accent mb-1"><i class="bi bi-people"></i> Parishioner Directory</h1>
            <p class="text-muted mb-0">Complete listing of all parish members</p>
        </div>
        <div sec:authorize="hasAnyRole('PRIEST','SECRETARY')">
            <a href="/export/options" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Export
            </a>
        </div>
    </div>

    <!-- Search Section -->
    <div class="card search-section">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-muted">Secular Name</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="secularNameSearch" class="form-control" placeholder="First & Last Name">
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Baptismal Name</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="baptismalNameSearch" class="form-control" placeholder="Baptismal & Last Name">
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Household</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="householdSearch" class="form-control" placeholder="Family Name">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th><a th:href="@{/parishioners(sortField='id', sortDir=${reverseSortDir})}" class="text-decoration-none">ID</a></th>
                            <th><a th:href="@{/parishioners(sortField='firstName', sortDir=${reverseSortDir})}" class="text-decoration-none">First</a></th>
                            <th><a th:href="@{/parishioners(sortField='lastName', sortDir=${reverseSortDir})}" class="text-decoration-none">Last</a></th>
                            <th><a th:href="@{/parishioners(sortField='baptismalName', sortDir=${reverseSortDir})}" class="text-decoration-none">Baptismal</a></th>
                            <th><a th:href="@{/parishioners(sortField='patronSaint', sortDir=${reverseSortDir})}" class="text-decoration-none">Saint</a></th>
                            <th><a th:href="@{/parishioners(sortField='status', sortDir=${reverseSortDir})}" class="text-decoration-none">Status</a></th>
                            <th><a th:href="@{/parishioners(sortField='maritalStatus', sortDir=${reverseSortDir})}" class="text-decoration-none">Marital</a></th>
                            <th><a th:href="@{/parishioners(sortField='birthday', sortDir=${reverseSortDir})}" class="text-decoration-none">Birthday</a></th>
                            <th><a th:href="@{/parishioners(sortField='baptismDate', sortDir=${reverseSortDir})}" class="text-decoration-none">Baptism</a></th>
                            <th><a th:href="@{/parishioners(sortField='chrismationDate', sortDir=${reverseSortDir})}" class="text-decoration-none">Chrismation</a></th>
                            <th><a th:href="@{/parishioners(sortField='marriageDate', sortDir=${reverseSortDir})}" class="text-decoration-none">Marriage</a></th>
                            <th><a th:href="@{/parishioners(sortField='nameDay', sortDir=${reverseSortDir})}" class="text-decoration-none">Name Day</a></th>
                            <th><a th:href="@{/parishioners(sortField='household.familyName', sortDir=${reverseSortDir})}" class="text-decoration-none">Household</a></th>
                            <th>Spouse</th>
                            <th>Godfather</th>
                            <th>Godmother</th>
                            <th>Sponsor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="p : ${parishioners}">
                            <td th:text="${p.id}"></td>
                            <td th:text="${p.firstName}"></td>
                            <td th:text="${p.lastName}"></td>
                            <td class="text-primary-accent fw-medium" th:text="${p.baptismalName}"></td>
                            <td th:text="${p.patronSaint}"></td>
                            <td><span class="badge bg-secondary" th:text="${p.status}"></span></td>
                            <td th:text="${p.maritalStatus}"></td>
                            <td th:text="${p.birthday}"></td>
                            <td th:text="${p.baptismDate}"></td>
                            <td th:text="${p.chrismationDate}"></td>
                            <td th:text="${p.marriageDate}"></td>
                            <td th:text="${p.nameDay}"></td>
                            <td th:text="${p.household != null ? p.household.familyName : '-'}"></td>
                            <td th:text="${p.spouse != null ? p.spouse.firstName + ' ' + p.spouse.lastName : p.manualSpouseName}"></td>
                            <td th:text="${p.godfather != null ? p.godfather.firstName + ' ' + p.godfather.lastName : p.manualGodfatherName}"></td>
                            <td th:text="${p.godmother != null ? p.godmother.firstName + ' ' + p.godmother.lastName : p.manualGodmotherName}"></td>
                            <td th:text="${p.weddingSponsor != null ? p.weddingSponsor.firstName + ' ' + p.weddingSponsor.lastName : p.manualSponsorName}"></td>
                            <td>
                                <a th:href="@{/parishioners/view/{id}(id=${p.id})}" class="btn btn-sm btn-outline-info">View</a>
                                <a th:href="@{/parishioners/edit/{id}(id=${p.id})}" class="btn btn-sm btn-outline-primary" sec:authorize="hasAnyRole('PRIEST','SECRETARY')">Edit</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Search functionality
    function filterTable() {
        const secularSearch = document.getElementById('secularNameSearch').value.toLowerCase();
        const baptismalSearch = document.getElementById('baptismalNameSearch').value.toLowerCase();
        const householdSearch = document.getElementById('householdSearch').value.toLowerCase();
        const rows = document.querySelectorAll('table tbody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const firstName = cells[1].textContent.toLowerCase();
            const lastName = cells[2].textContent.toLowerCase();
            const baptismalName = cells[3].textContent.toLowerCase();
            const household = cells[12].textContent.toLowerCase();

            const secularMatch = !secularSearch || (firstName + ' ' + lastName).includes(secularSearch);
            const baptismalMatch = !baptismalSearch || (baptismalName + ' ' + lastName).includes(baptismalSearch);
            const householdMatch = !householdSearch || household.includes(householdSearch);

            row.style.display = (secularMatch && baptismalMatch && householdMatch) ? '' : 'none';
        });
    }

    document.getElementById('secularNameSearch').addEventListener('keyup', filterTable);
    document.getElementById('baptismalNameSearch').addEventListener('keyup', filterTable);
    document.getElementById('householdSearch').addEventListener('keyup', filterTable);
</script>
</body>
</html>
