<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Submission Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <style>
        .comparison-table { margin-top: 20px; }
        .comparison-table th { background-color: var(--accent-gold); color: black; }
        .changed { background-color: rgba(212, 175, 55, 0.2); }
        .field-label { font-weight: bold; color: var(--accent-gold); }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="text-gold fw-bold">Review Submission</h1>
            </div>
            <div class="col-md-4 text-end">
                <a href="/submissions/review" class="btn btn-outline-secondary">Back to List</a>
            </div>
        </div>

        <div class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-info-circle"></i> Submission Details
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><span class="field-label">Type:</span>
                            <span th:if="${submission.submissionType.name() == 'NEW'}" class="badge bg-info">NEW PARISHIONER</span>
                            <span th:unless="${submission.submissionType.name() == 'NEW'}" class="badge bg-warning">UPDATE REQUEST</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><span class="field-label">Status:</span>
                            <span th:if="${submission.status.name() == 'PENDING'}" class="badge bg-warning">PENDING</span>
                            <span th:if="${submission.status.name() == 'APPROVED'}" class="badge bg-success">APPROVED</span>
                            <span th:if="${submission.status.name() == 'REJECTED'}" class="badge bg-danger">REJECTED</span>
                        </p>
                    </div>
                </div>
                <p><span class="field-label">Submitted:</span> <span th:text="${#temporals.format(submission.submittedAt, 'MMMM dd, yyyy HH:mm')}"></span></p>
                <div th:if="${submission.reviewedAt != null}">
                    <p><span class="field-label">Reviewed:</span> <span th:text="${#temporals.format(submission.reviewedAt, 'MMMM dd, yyyy HH:mm')}"></span> by <span th:text="${submission.reviewedBy}"></span></p>
                </div>
                <div th:if="${submission.reviewNotes != null}">
                    <p><span class="field-label">Notes:</span> <span th:text="${submission.reviewNotes}"></span></p>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: SELECT TARGET PARISHIONER -->
        <div th:if="${isUpdate}" class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-search"></i> Select Parishioner to Update
            </div>
            <div class="card-body">
                <p class="text-muted">The person submitted: <strong th:text="${submission.firstName + ' ' + submission.lastName}"></strong></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Manually select which parishioner this update applies to, or leave blank to create as a new record.
                </div>
                <div class="mb-3">
                    <label for="targetParishionerSelect" class="form-label text-gold">Select Parishioner to Update:</label>
                    <select id="targetParishionerSelect" name="targetParishionerId" class="form-select">
                        <option value="">-- Create as new parishioner --</option>
                        <option th:each="p : ${allParishioners}" th:value="${p.id}" th:text="${p.firstName + ' ' + p.lastName}" th:selected="${currentParishioner != null && currentParishioner.id == p.id}"></option>
                    </select>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: SIDE-BY-SIDE COMPARISON (shown if target selected) -->
        <div th:if="${isUpdate && currentParishioner != null}" class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-arrow-left-right"></i> Current Data vs. Submitted Changes</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="selectAllFields()">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="selectChangedFields()">Select Changed</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="deselectAllFields()">Deselect All</button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Check the fields you want to update. Changed fields are highlighted in gold.
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered comparison-table table-sm">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Apply</th>
                                <th>Field</th>
                                <th style="width: 30%;">Current Value</th>
                                <th style="width: 30%;">Submitted Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- SECTION: BASIC INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-person"></i> Basic Information</td>
                            </tr>
                            <tr th:classappend="${currentParishioner.firstName != submission.firstName ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="firstName"
                                           th:checked="${currentParishioner.firstName != submission.firstName}"
                                           th:data-changed="${currentParishioner.firstName != submission.firstName}">
                                </td>
                                <td><strong>First Name</strong></td>
                                <td th:text="${currentParishioner.firstName}"></td>
                                <td th:text="${submission.firstName}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.lastName != submission.lastName ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="lastName"
                                           th:checked="${currentParishioner.lastName != submission.lastName}"
                                           th:data-changed="${currentParishioner.lastName != submission.lastName}">
                                </td>
                                <td><strong>Last Name</strong></td>
                                <td th:text="${currentParishioner.lastName}"></td>
                                <td th:text="${submission.lastName}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="nameSuffix"
                                           th:checked="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '')}"
                                           th:data-changed="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '')}">
                                </td>
                                <td>Name Suffix</td>
                                <td th:text="${currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '(not set)'}"></td>
                                <td th:text="${submission.nameSuffix != null ? submission.nameSuffix : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.birthday != submission.birthday ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="birthday"
                                           th:checked="${currentParishioner.birthday != submission.birthday}"
                                           th:data-changed="${currentParishioner.birthday != submission.birthday}">
                                </td>
                                <td>Birthday</td>
                                <td th:text="${currentParishioner.birthday != null ? #temporals.format(currentParishioner.birthday, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.birthday != null ? #temporals.format(submission.birthday, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="membershipStatus"
                                           th:checked="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '')}"
                                           th:data-changed="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '')}">
                                </td>
                                <td>Membership Status</td>
                                <td th:text="${currentParishioner.status != null ? currentParishioner.status : '(not set)'}"></td>
                                <td th:text="${submission.membershipStatus != null ? submission.membershipStatus : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: CONTACT INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-telephone"></i> Contact Information</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="phoneNumber"
                                           th:checked="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '')}"
                                           th:data-changed="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '')}">
                                </td>
                                <td>Phone</td>
                                <td th:text="${currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '(not set)'}"></td>
                                <td th:text="${submission.phoneNumber != null ? submission.phoneNumber : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="email"
                                           th:checked="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '')}"
                                           th:data-changed="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '')}">
                                </td>
                                <td>Email</td>
                                <td th:text="${currentParishioner.email != null ? currentParishioner.email : '(not set)'}"></td>
                                <td th:text="${submission.email != null ? submission.email : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: MARRIAGE INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-heart"></i> Marriage Information</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="maritalStatus"
                                           th:checked="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '')}"
                                           th:data-changed="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '')}">
                                </td>
                                <td>Marital Status</td>
                                <td th:text="${currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '(not set)'}"></td>
                                <td th:text="${submission.maritalStatus != null ? submission.maritalStatus : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.marriageDate != submission.marriageDate ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="marriageDate"
                                           th:checked="${currentParishioner.marriageDate != submission.marriageDate}"
                                           th:data-changed="${currentParishioner.marriageDate != submission.marriageDate}">
                                </td>
                                <td>Marriage Date</td>
                                <td th:text="${currentParishioner.marriageDate != null ? #temporals.format(currentParishioner.marriageDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.marriageDate != null ? #temporals.format(submission.marriageDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: ORTHODOX INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-cross"></i> Orthodox Church Information</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="baptismalName"
                                           th:checked="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '')}"
                                           th:data-changed="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '')}">
                                </td>
                                <td>Baptismal Name</td>
                                <td th:text="${currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '(not set)'}"></td>
                                <td th:text="${submission.baptismalName != null ? submission.baptismalName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="patronSaint"
                                           th:checked="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '')}"
                                           th:data-changed="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '')}">
                                </td>
                                <td>Patron Saint</td>
                                <td th:text="${currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '(not set)'}"></td>
                                <td th:text="${submission.patronSaint != null ? submission.patronSaint : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.baptismDate != submission.baptismDate ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="baptismDate"
                                           th:checked="${currentParishioner.baptismDate != submission.baptismDate}"
                                           th:data-changed="${currentParishioner.baptismDate != submission.baptismDate}">
                                </td>
                                <td>Baptism Date</td>
                                <td th:text="${currentParishioner.baptismDate != null ? #temporals.format(currentParishioner.baptismDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.baptismDate != null ? #temporals.format(submission.baptismDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.chrismationDate != submission.chrismationDate ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="chrismationDate"
                                           th:checked="${currentParishioner.chrismationDate != submission.chrismationDate}"
                                           th:data-changed="${currentParishioner.chrismationDate != submission.chrismationDate}">
                                </td>
                                <td>Chrismation Date</td>
                                <td th:text="${currentParishioner.chrismationDate != null ? #temporals.format(currentParishioner.chrismationDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.chrismationDate != null ? #temporals.format(submission.chrismationDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: RELATIONSHIPS -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-people"></i> Relationships (Manual Entry)</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '') != (submission.manualGodfatherName != null ? submission.manualGodfatherName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualGodfatherName"
                                           th:checked="${(currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '') != (submission.manualGodfatherName != null ? submission.manualGodfatherName : '')}"
                                           th:data-changed="${(currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '') != (submission.manualGodfatherName != null ? submission.manualGodfatherName : '')}">
                                </td>
                                <td>Godfather (Koumparos)</td>
                                <td th:text="${currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '(not set)'}"></td>
                                <td th:text="${submission.manualGodfatherName != null ? submission.manualGodfatherName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '') != (submission.manualGodmotherName != null ? submission.manualGodmotherName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualGodmotherName"
                                           th:checked="${(currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '') != (submission.manualGodmotherName != null ? submission.manualGodmotherName : '')}"
                                           th:data-changed="${(currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '') != (submission.manualGodmotherName != null ? submission.manualGodmotherName : '')}">
                                </td>
                                <td>Godmother (Koumpara)</td>
                                <td th:text="${currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '(not set)'}"></td>
                                <td th:text="${submission.manualGodmotherName != null ? submission.manualGodmotherName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '') != (submission.manualSpouseName != null ? submission.manualSpouseName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualSpouseName"
                                           th:checked="${(currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '') != (submission.manualSpouseName != null ? submission.manualSpouseName : '')}"
                                           th:data-changed="${(currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '') != (submission.manualSpouseName != null ? submission.manualSpouseName : '')}">
                                </td>
                                <td>Spouse Name (Manual)</td>
                                <td th:text="${currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '(not set)'}"></td>
                                <td th:text="${submission.manualSpouseName != null ? submission.manualSpouseName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '') != (submission.manualSponsorName != null ? submission.manualSponsorName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualSponsorName"
                                           th:checked="${(currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '') != (submission.manualSponsorName != null ? submission.manualSponsorName : '')}"
                                           th:data-changed="${(currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '') != (submission.manualSponsorName != null ? submission.manualSponsorName : '')}">
                                </td>
                                <td>Sponsor Name</td>
                                <td th:text="${currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '(not set)'}"></td>
                                <td th:text="${submission.manualSponsorName != null ? submission.manualSponsorName : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: HOUSEHOLD ADDRESS -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-house"></i> Household Address (Display Only)</td>
                            </tr>
                            <tr>
                                <td class="text-center text-muted">-</td>
                                <td>Street Address</td>
                                <td th:text="${currentParishioner.household != null and currentParishioner.household.address != null ? currentParishioner.household.address : '(not set)'}"></td>
                                <td th:text="${submission.address != null ? submission.address : '(not set)'}"></td>
                            </tr>
                            <tr>
                                <td class="text-center text-muted">-</td>
                                <td>City</td>
                                <td th:text="${currentParishioner.household != null and currentParishioner.household.city != null ? currentParishioner.household.city : '(not set)'}"></td>
                                <td th:text="${submission.city != null ? submission.city : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: CHILDREN (Display Only) -->
                            <tr th:if="${submission.childrenList != null and submission.childrenList.size() > 0}" class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-person-badge"></i> Children (Display Only)</td>
                            </tr>
                            <tr th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                                <td class="text-center text-muted">-</td>
                                <td>Children</td>
                                <td>-</td>
                                <td>
                                    <ul class="mb-0 ps-3">
                                        <li th:each="child : ${submission.childrenList}">
                                            <span th:text="${child.name}"></span>
                                            <span th:if="${child.birthday != null}" class="text-muted">
                                                (Born: <span th:text="${#temporals.format(child.birthday, 'MMM dd, yyyy')}"></span>)
                                            </span>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- NEW SUBMISSION: FULL DATA DISPLAY -->
        <div th:unless="${isUpdate}" class="card bg-secondary border-gold mb-4">
            <div class="card-header bg-gold text-dark fw-bold">
                <i class="bi bi-file-earmark-text"></i> Submitted Information
            </div>
            <div class="card-body">
                <!-- BASIC INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-gold fw-bold mb-3">Basic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">First Name:</span> <span th:text="${submission.firstName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">Last Name:</span> <span th:text="${submission.lastName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.nameSuffix != null}">
                            <p><span class="field-label">Name Suffix:</span> <span th:text="${submission.nameSuffix}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.birthday != null}">
                            <p><span class="field-label">Birthday:</span> <span th:text="${#temporals.format(submission.birthday, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">Membership Status:</span> <span th:text="${submission.membershipStatus}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- CONTACT INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-gold fw-bold mb-3">Contact Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.email != null}">
                            <p><span class="field-label">Email:</span> <span th:text="${submission.email}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.phoneNumber != null}">
                            <p><span class="field-label">Phone:</span> <span th:text="${submission.phoneNumber}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ADDRESS -->
                <div class="mb-4" th:if="${submission.address != null or submission.city != null}">
                    <h6 class="text-gold fw-bold mb-3">Address</h6>
                    <div class="row">
                        <div class="col-md-12 mb-2" th:if="${submission.address != null}">
                            <p><span class="field-label">Street:</span> <span th:text="${submission.address}"></span></p>
                        </div>
                        <div class="col-md-12 mb-2" th:if="${submission.city != null}">
                            <p><span class="field-label">City:</span> <span th:text="${submission.city}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- MARITAL STATUS -->
                <div class="mb-4" th:if="${submission.maritalStatus != null}">
                    <h6 class="text-gold fw-bold mb-3">Marital Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <p><span class="field-label">Marital Status:</span> <span th:text="${submission.maritalStatus}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.marriageDate != null}">
                            <p><span class="field-label">Marriage Date:</span> <span th:text="${#temporals.format(submission.marriageDate, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- RELATIONSHIPS -->
                <div class="mb-4" th:if="${submission.manualSpouseName != null or submission.manualGodfatherName != null or submission.manualGodmotherName != null or submission.manualSponsorName != null}">
                    <h6 class="text-gold fw-bold mb-3">Relationships (Manual Entry)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.manualSpouseName != null}">
                            <p><span class="field-label">Spouse:</span> <span th:text="${submission.manualSpouseName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.manualGodfatherName != null}">
                            <p><span class="field-label">Godfather:</span> <span th:text="${submission.manualGodfatherName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.manualGodmotherName != null}">
                            <p><span class="field-label">Godmother:</span> <span th:text="${submission.manualGodmotherName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.manualSponsorName != null}">
                            <p><span class="field-label">Sponsor:</span> <span th:text="${submission.manualSponsorName}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- SPOUSE CREATION INFORMATION -->
                <div class="mb-4" th:if="${submission.spouseFirstName != null or submission.spouseLastName != null or submission.spouseEmail != null or submission.spousePhoneNumber != null}">
                    <h6 class="text-gold fw-bold mb-3">New Spouse Information (To Create)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.spouseFirstName != null}">
                            <p><span class="field-label">Spouse First Name:</span> <span th:text="${submission.spouseFirstName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spouseLastName != null}">
                            <p><span class="field-label">Spouse Last Name:</span> <span th:text="${submission.spouseLastName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spouseEmail != null}">
                            <p><span class="field-label">Spouse Email:</span> <span th:text="${submission.spouseEmail}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spousePhoneNumber != null}">
                            <p><span class="field-label">Spouse Phone:</span> <span th:text="${submission.spousePhoneNumber}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ORTHODOX INFORMATION -->
                <div class="mb-4" th:if="${submission.isOrthodox}">
                    <h6 class="text-gold fw-bold mb-3">Orthodox Church Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.baptismalName != null}">
                            <p><span class="field-label">Baptismal Name:</span> <span th:text="${submission.baptismalName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.patronSaint != null}">
                            <p><span class="field-label">Patron Saint:</span> <span th:text="${submission.patronSaint}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.baptismDate != null}">
                            <p><span class="field-label">Baptism Date:</span> <span th:text="${#temporals.format(submission.baptismDate, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.chrismationDate != null}">
                            <p><span class="field-label">Chrismation Date:</span> <span th:text="${#temporals.format(submission.chrismationDate, 'MMMM dd, yyyy')}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- CHILDREN -->
                <div class="mb-4" th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                    <h6 class="text-gold fw-bold mb-3">Children</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr style="background-color: var(--accent-gold); color: black;">
                                            <th>Child Name</th>
                                            <th>Birthday</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="child : ${submission.childrenList}">
                                            <td th:text="${child.name}"></td>
                                            <td th:text="${child.birthday != null ? #temporals.format(child.birthday, 'MMMM dd, yyyy') : 'Not provided'}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APPROVAL/REJECTION ACTIONS -->
        <div th:if="${submission.status.name() == 'PENDING'}" class="row">
            <div class="col-md-6">
                <form id="approveForm" th:action="@{/submissions/review/{id}/approve(id=${submission.id})}" method="post" class="card bg-success border-0">
                    <div class="card-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="approveTargetParishionerId" name="targetParishionerId" value="" />
                        <button type="submit" class="btn btn-success w-100 fw-bold">
                            <i class="bi bi-check-circle"></i> Approve & Create/Update
                        </button>
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <form id="rejectForm" th:action="@{/submissions/review/{id}/reject(id=${submission.id})}" method="post" class="card bg-danger border-0">
                    <div class="card-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="rejectTargetParishionerId" name="targetParishionerId" value="" />
                        <textarea name="rejectionNotes" class="form-control form-control-sm mb-2" placeholder="Reason for rejection (optional)"></textarea>
                        <button type="submit" class="btn btn-danger w-100 fw-bold">
                            <i class="bi bi-x-circle"></i> Reject
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-3">
            <a href="/submissions/review" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const submissionId = window.location.pathname.split('/').pop();
        const approveForm = document.getElementById('approveForm');
        const rejectForm = document.getElementById('rejectForm');
        const targetParishionerSelect = document.getElementById('targetParishionerSelect');

        // Get CSRF token from meta tags or from hidden input in approve form
        function getCsrfToken() {
            const token = document.querySelector('meta[name="_csrf"]');
            if (token) return token.getAttribute('content');

            // Fallback: get from hidden input in any form
            const csrfInput = document.querySelector('input[name="_csrf"]');
            if (csrfInput) return csrfInput.value;

            return '';
        }

        function getCsrfHeader() {
            const header = document.querySelector('meta[name="_csrf_header"]');
            if (header) return header.getAttribute('content');
            return 'X-CSRF-TOKEN';
        }

        // When parishioner is selected, reload page with that parishioner loaded
        if (targetParishionerSelect) {
            targetParishionerSelect.addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    // Reload page - the controller will load the selected parishioner
                    // We pass it via a hidden form submission that will load it
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/submissions/review/' + submissionId + '/load-parishioner';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'targetParishionerId';
                    input.value = selectedId;
                    form.appendChild(input);

                    // Add CSRF token
                    const csrfToken = getCsrfToken();
                    const csrfHeader = getCsrfHeader();
                    if (csrfToken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = csrfHeader === 'X-CSRF-TOKEN' ? '_csrf' : csrfHeader;
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // Field selection helper functions
        function selectAllFields() {
            document.querySelectorAll('.field-checkbox').forEach(cb => cb.checked = true);
        }

        function selectChangedFields() {
            document.querySelectorAll('.field-checkbox').forEach(cb => {
                cb.checked = cb.getAttribute('data-changed') === 'true';
            });
        }

        function deselectAllFields() {
            document.querySelectorAll('.field-checkbox').forEach(cb => cb.checked = false);
        }

        // Collect selected fields and add to form before submission
        function collectSelectedFields(form) {
            // Remove any existing fieldsToUpdate inputs
            form.querySelectorAll('input[name="fieldsToUpdate"]').forEach(el => el.remove());

            // Add checked fields
            document.querySelectorAll('.field-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'fieldsToUpdate';
                input.value = cb.value;
                form.appendChild(input);
            });
        }

        // Populate target parishioner ID and selected fields when forms are submitted
        if (approveForm && targetParishionerSelect) {
            approveForm.addEventListener('submit', function(e) {
                document.getElementById('approveTargetParishionerId').value = targetParishionerSelect.value;
                collectSelectedFields(approveForm);
            });
        } else if (approveForm) {
            // No parishioner selector (NEW submission), but still collect fields if they exist
            approveForm.addEventListener('submit', function(e) {
                collectSelectedFields(approveForm);
            });
        }

        if (rejectForm && targetParishionerSelect) {
            rejectForm.addEventListener('submit', function() {
                document.getElementById('rejectTargetParishionerId').value = targetParishionerSelect.value;
            });
        }
    </script>
</body>
</html>
