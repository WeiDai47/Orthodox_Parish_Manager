<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Submission Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/theme.css}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
        .comparison-table { margin-top: 20px; }
        .comparison-table th { background-color: #f8f9fa; color: black; border-bottom: 2px solid #333; }
        .changed { background-color: #e9ecef; }
        .field-label { font-weight: bold; color: black; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="text-dark fw-bold">Review Submission</h1>
            </div>
            <div class="col-md-4 text-end">
                <button id="toggleEditMode" class="btn btn-warning me-2" th:if="${submission.status.name() == 'PENDING' && !isUpdate}">
                    <i class="bi bi-pencil-square"></i> Enable Edit Mode
                </button>
                <a href="/submissions/review" class="btn btn-outline-secondary">Back to List</a>
            </div>
        </div>

        <div class="card bg-white border-dark mb-4">
            <div class="card-header bg-light text-dark fw-bold border-bottom border-dark">
                <i class="bi bi-info-circle"></i> Submission Details
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><span class="field-label">Type:</span>
                            <span th:if="${submission.submissionType.name() == 'NEW'}" class="badge bg-info">NEW PARISHIONER</span>
                            <span th:unless="${submission.submissionType.name() == 'NEW'}" class="badge bg-warning">UPDATE REQUEST</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><span class="field-label">Status:</span>
                            <span th:if="${submission.status.name() == 'PENDING'}" class="badge bg-warning">PENDING</span>
                            <span th:if="${submission.status.name() == 'APPROVED'}" class="badge bg-success">APPROVED</span>
                            <span th:if="${submission.status.name() == 'REJECTED'}" class="badge bg-danger">REJECTED</span>
                        </p>
                    </div>
                </div>
                <p><span class="field-label">Submitted:</span> <span th:text="${#temporals.format(submission.submittedAt, 'MMMM dd, yyyy HH:mm')}"></span></p>
                <div th:if="${submission.reviewedAt != null}">
                    <p><span class="field-label">Reviewed:</span> <span th:text="${#temporals.format(submission.reviewedAt, 'MMMM dd, yyyy HH:mm')}"></span> by <span th:text="${submission.reviewedBy}"></span></p>
                </div>
                <div th:if="${submission.reviewNotes != null}">
                    <p><span class="field-label">Notes:</span> <span th:text="${submission.reviewNotes}"></span></p>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: FULL SUBMITTED DATA DISPLAY -->
        <div th:if="${isUpdate}" class="card bg-white border-dark mb-4">
            <div class="card-header bg-light text-dark fw-bold border-bottom border-dark d-flex justify-content-between align-items-center">
                <span><i class="bi bi-file-earmark-text"></i> Submitted Information</span>
                <button id="toggleEditModeUpdate" class="btn btn-sm btn-warning" th:if="${submission.status.name() == 'PENDING'}">
                    <i class="bi bi-pencil-square"></i> Enable Edit Mode
                </button>
            </div>
            <div class="card-body">
                <!-- BASIC INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Basic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">First Name:</span>
                            <span class="view-mode" th:text="${submission.firstName}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="firstName"
                                   th:value="${submission.firstName}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Last Name:</span>
                            <span class="view-mode" th:text="${submission.lastName}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="lastName"
                                   th:value="${submission.lastName}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Name Suffix:</span>
                            <span class="view-mode" th:text="${submission.nameSuffix != null ? submission.nameSuffix : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="nameSuffix"
                                   th:value="${submission.nameSuffix}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Birthday:</span>
                            <span class="view-mode" th:text="${submission.birthday != null ? #temporals.format(submission.birthday, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="birthday"
                                   th:value="${submission.birthday}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- CONTACT INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Contact Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Email:</span>
                            <span class="view-mode" th:text="${submission.email != null ? submission.email : '(not set)'}"></span>
                            <input type="email" class="edit-mode form-control form-control-sm" name="email"
                                   th:value="${submission.email}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Phone:</span>
                            <span class="view-mode" th:text="${submission.phoneNumber != null ? submission.phoneNumber : '(not set)'}"></span>
                            <input type="tel" class="edit-mode form-control form-control-sm" name="phoneNumber"
                                   th:value="${submission.phoneNumber}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- ADDRESS -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Address</h6>
                    <div class="row">
                        <div class="col-md-12 mb-2">
                            <span class="field-label">Street:</span>
                            <span class="view-mode" th:text="${submission.address != null ? submission.address : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="address"
                                   th:value="${submission.address}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">City:</span>
                            <span class="view-mode" th:text="${submission.city != null ? submission.city : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="city"
                                   th:value="${submission.city}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Zip Code:</span>
                            <span class="view-mode" th:text="${submission.zipCode != null ? submission.zipCode : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="zipCode"
                                   th:value="${submission.zipCode}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- MARITAL STATUS -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Marital Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Marital Status:</span>
                            <span class="view-mode" th:text="${submission.maritalStatus != null ? submission.maritalStatus : '(not set)'}"></span>
                            <select class="edit-mode form-control form-control-sm" name="maritalStatus" style="display:none;">
                                <option value="">-- Select --</option>
                                <option value="SINGLE">SINGLE</option>
                                <option value="MARRIED">MARRIED</option>
                                <option value="WIDOWED">WIDOWED</option>
                                <option value="DIVORCED">DIVORCED</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Marriage Date:</span>
                            <span class="view-mode" th:text="${submission.marriageDate != null ? #temporals.format(submission.marriageDate, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="marriageDate"
                                   th:value="${submission.marriageDate}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- WARNING: MARRIED STATUS WITHOUT SPOUSE ASSIGNMENT (UPDATE ONLY) -->
                <div th:if="${isUpdate and submission.maritalStatus != null and submission.maritalStatus == 'MARRIED'}" class="alert alert-warning border-warning mb-4" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-3" style="font-size: 1.25rem; margin-top: 2px;"></i>
                        <div>
                            <strong>Spouse Assignment Required</strong>
                            <p class="mb-2">This person is marked as married. You must assign a spouse to another parishioner in the system when approving this submission.</p>
                            <p class="mb-0">If the spouse is not yet in the system, you can <a href="/parishioners/add" target="_blank" class="fw-bold text-warning text-decoration-underline">add them as a member here</a>. Then come back and link them in the relationship assignment section.</p>
                        </div>
                    </div>
                </div>

                <!-- ORTHODOX INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Orthodox Church Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Baptismal Name:</span>
                            <span class="view-mode" th:text="${submission.baptismalName != null ? submission.baptismalName : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="baptismalName"
                                   th:value="${submission.baptismalName}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Patron Saint:</span>
                            <span class="view-mode" th:text="${submission.patronSaint != null ? submission.patronSaint : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="patronSaint"
                                   th:value="${submission.patronSaint}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Baptism Date:</span>
                            <span class="view-mode" th:text="${submission.baptismDate != null ? #temporals.format(submission.baptismDate, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="baptismDate"
                                   th:value="${submission.baptismDate}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Chrismation Date:</span>
                            <span class="view-mode" th:text="${submission.chrismationDate != null ? #temporals.format(submission.chrismationDate, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="chrismationDate"
                                   th:value="${submission.chrismationDate}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- RELATIONSHIP ASSIGNMENT (EDIT MODE - UPDATE) -->
                <div class="mb-4 edit-mode" style="display:none;">
                    <h6 class="text-dark fw-bold mb-3"><i class="bi bi-link-45deg"></i> Assign Relationships</h6>

                    <!-- Spouse -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Spouse to Existing Member</label>
                            <select id="spouseSelectUpdate" class="search-select" data-manual-target="manualSpouseNameUpdate">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep as Manual Entry</label>
                            <input type="text" id="manualSpouseNameUpdate" class="form-control manual-input"
                                   placeholder="Manual spouse name"
                                   data-select-target="spouseSelectUpdate">
                        </div>
                    </div>

                    <!-- Godfather -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Godfather to Member</label>
                            <select id="godfatherSelectUpdate" class="search-select" data-manual-target="manualGodfatherNameUpdate">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep Manual</label>
                            <input type="text" id="manualGodfatherNameUpdate" class="form-control manual-input"
                                   placeholder="Manual godfather name"
                                   data-select-target="godfatherSelectUpdate">
                        </div>
                    </div>

                    <!-- Godmother -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Godmother to Member</label>
                            <select id="godmotherSelectUpdate" class="search-select" data-manual-target="manualGodmotherNameUpdate">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep Manual</label>
                            <input type="text" id="manualGodmotherNameUpdate" class="form-control manual-input"
                                   placeholder="Manual godmother name"
                                   data-select-target="godmotherSelectUpdate">
                        </div>
                    </div>

                    <!-- Sponsor -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Sponsor to Member</label>
                            <select id="sponsorSelectUpdate" class="search-select" data-manual-target="manualSponsorNameUpdate">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep Manual</label>
                            <input type="text" id="manualSponsorNameUpdate" class="form-control manual-input"
                                   placeholder="Manual sponsor name"
                                   data-select-target="sponsorSelectUpdate">
                        </div>
                    </div>

                    <!-- Household -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Assign to Existing Household</label>
                            <select id="householdSelectUpdate" class="search-select">
                                <option value="">-- None / Create New --</option>
                                <option th:each="h : ${allHouseholds}"
                                        th:value="${h.id}"
                                        th:text="${h.familyName + ' Household (' + (h.address != null ? h.address : 'no address') + ')'}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Create New Household</label>
                            <input type="text" id="newHouseholdNameUpdate" class="form-control"
                                   placeholder="Enter family name for new household">
                        </div>
                    </div>
                </div>

                <!-- CHILDREN LINKING/CREATION (EDIT MODE - UPDATE) -->
                <div class="mb-4 edit-mode" style="display:none;" th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                    <h6 class="text-dark fw-bold mb-3"><i class="bi bi-people-fill"></i> Assign Children</h6>
                    <p class="text-muted">For each child, either link to an existing parishioner or mark for creation.</p>

                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead style="background-color: #f8f9fa; color: black; border-bottom: 2px solid #333;">
                                <tr>
                                    <th>Child Name (from submission)</th>
                                    <th>Birthday</th>
                                    <th>Link to Existing Member</th>
                                    <th>OR Create New</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="child, iterStat : ${submission.childrenList}">
                                    <td th:text="${child.name}"></td>
                                    <td th:text="${child.birthday != null ? #temporals.format(child.birthday, 'MMM dd, yyyy') : 'Not provided'}"></td>
                                    <td>
                                        <select th:name="|childLinkIds[${iterStat.index}]|" class="search-select-child form-control-sm" th:data-child-index="${iterStat.index}">
                                            <option value="">-- Select Member --</option>
                                            <option th:each="p : ${allParishioners}"
                                                    th:value="${p.id}"
                                                    th:text="${p.firstName + ' ' + p.lastName + (p.birthday != null ? ' (born ' + #temporals.format(p.birthday, 'yyyy') + ')' : '')}">
                                            </option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" th:name="|childCreateIndexes|" th:value="${iterStat.index}" class="form-check-input child-create-checkbox" th:data-child-index="${iterStat.index}" checked>
                                        <small class="text-muted d-block">Create as new</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: SELECT TARGET PARISHIONER -->
        <div th:if="${isUpdate}" class="card bg-white border-dark mb-4">
            <div class="card-header bg-light text-dark fw-bold border-bottom border-dark">
                <i class="bi bi-search"></i> Select Parishioner to Update
            </div>
            <div class="card-body">
                <p class="text-muted">The person submitted: <strong th:text="${submission.firstName + ' ' + submission.lastName}"></strong></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Manually select which parishioner this update applies to, or leave blank to create as a new record.
                </div>
                <div class="mb-3">
                    <label for="targetParishionerSelect" class="form-label text-dark">Select Parishioner to Update:</label>
                    <select id="targetParishionerSelect" name="targetParishionerId" class="form-select">
                        <option value="">-- Create as new parishioner --</option>
                        <option th:each="p : ${allParishioners}" th:value="${p.id}" th:text="${p.firstName + ' ' + p.lastName}" th:selected="${currentParishioner != null && currentParishioner.id == p.id}"></option>
                    </select>
                </div>
            </div>
        </div>

        <!-- UPDATE SUBMISSION: SIDE-BY-SIDE COMPARISON (shown if target selected) -->
        <div th:if="${isUpdate && currentParishioner != null}" class="card bg-white border-dark mb-4">
            <div class="card-header bg-light text-dark fw-bold border-bottom border-dark d-flex justify-content-between align-items-center">
                <span><i class="bi bi-arrow-left-right"></i> Current Data vs. Submitted Changes</span>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="selectAllFields()">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="selectChangedFields()">Select Changed</button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="deselectAllFields()">Deselect All</button>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Check the fields you want to update. Changed fields are highlighted in gold.
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered comparison-table table-sm">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Apply</th>
                                <th>Field</th>
                                <th style="width: 30%;">Current Value</th>
                                <th style="width: 30%;">Submitted Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- SECTION: BASIC INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-person"></i> Basic Information</td>
                            </tr>
                            <tr th:classappend="${currentParishioner.firstName != submission.firstName ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="firstName"
                                           th:checked="${currentParishioner.firstName != submission.firstName and (submission.firstName != null and !submission.firstName.isEmpty())}"
                                           th:data-changed="${currentParishioner.firstName != submission.firstName}"
                                           th:data-would-clear="${(currentParishioner.firstName != null and !currentParishioner.firstName.isEmpty()) and (submission.firstName == null or submission.firstName.isEmpty())}"
                                           th:data-field-name="'First Name'">
                                </td>
                                <td><strong>First Name</strong></td>
                                <td th:text="${currentParishioner.firstName}"></td>
                                <td th:text="${submission.firstName}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.lastName != submission.lastName ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="lastName"
                                           th:checked="${currentParishioner.lastName != submission.lastName and (submission.lastName != null and !submission.lastName.isEmpty())}"
                                           th:data-changed="${currentParishioner.lastName != submission.lastName}"
                                           th:data-would-clear="${(currentParishioner.lastName != null and !currentParishioner.lastName.isEmpty()) and (submission.lastName == null or submission.lastName.isEmpty())}"
                                           th:data-field-name="'Last Name'">
                                </td>
                                <td><strong>Last Name</strong></td>
                                <td th:text="${currentParishioner.lastName}"></td>
                                <td th:text="${submission.lastName}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="nameSuffix"
                                           th:checked="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '') and (submission.nameSuffix != null and !submission.nameSuffix.isEmpty())}"
                                           th:data-changed="${(currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '') != (submission.nameSuffix != null ? submission.nameSuffix : '')}"
                                           th:data-would-clear="${(currentParishioner.nameSuffix != null and !currentParishioner.nameSuffix.isEmpty()) and (submission.nameSuffix == null or submission.nameSuffix.isEmpty())}"
                                           th:data-field-name="'Name Suffix'">
                                </td>
                                <td>Name Suffix</td>
                                <td th:text="${currentParishioner.nameSuffix != null ? currentParishioner.nameSuffix : '(not set)'}"></td>
                                <td th:text="${submission.nameSuffix != null ? submission.nameSuffix : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.birthday != submission.birthday ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="birthday"
                                           th:checked="${currentParishioner.birthday != submission.birthday and submission.birthday != null}"
                                           th:data-changed="${currentParishioner.birthday != submission.birthday}"
                                           th:data-would-clear="${currentParishioner.birthday != null and submission.birthday == null}"
                                           th:data-field-name="'Birthday'">
                                </td>
                                <td>Birthday</td>
                                <td th:text="${currentParishioner.birthday != null ? #temporals.format(currentParishioner.birthday, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.birthday != null ? #temporals.format(submission.birthday, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="membershipStatus"
                                           th:checked="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '') and submission.membershipStatus != null}"
                                           th:data-changed="${(currentParishioner.status != null ? currentParishioner.status : '') != (submission.membershipStatus != null ? submission.membershipStatus : '')}"
                                           th:data-would-clear="${currentParishioner.status != null and submission.membershipStatus == null}"
                                           th:data-field-name="'Membership Status'">
                                </td>
                                <td>Membership Status</td>
                                <td th:text="${currentParishioner.status != null ? currentParishioner.status : '(not set)'}"></td>
                                <td th:text="${submission.membershipStatus != null ? submission.membershipStatus : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: CONTACT INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-telephone"></i> Contact Information</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="phoneNumber"
                                           th:checked="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '') and (submission.phoneNumber != null and !submission.phoneNumber.isEmpty())}"
                                           th:data-changed="${(currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '') != (submission.phoneNumber != null ? submission.phoneNumber : '')}"
                                           th:data-would-clear="${(currentParishioner.phoneNumber != null and !currentParishioner.phoneNumber.isEmpty()) and (submission.phoneNumber == null or submission.phoneNumber.isEmpty())}"
                                           th:data-field-name="'Phone'">
                                </td>
                                <td>Phone</td>
                                <td th:text="${currentParishioner.phoneNumber != null ? currentParishioner.phoneNumber : '(not set)'}"></td>
                                <td th:text="${submission.phoneNumber != null ? submission.phoneNumber : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="email"
                                           th:checked="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '') and (submission.email != null and !submission.email.isEmpty())}"
                                           th:data-changed="${(currentParishioner.email != null ? currentParishioner.email : '') != (submission.email != null ? submission.email : '')}"
                                           th:data-would-clear="${(currentParishioner.email != null and !currentParishioner.email.isEmpty()) and (submission.email == null or submission.email.isEmpty())}"
                                           th:data-field-name="'Email'">
                                </td>
                                <td>Email</td>
                                <td th:text="${currentParishioner.email != null ? currentParishioner.email : '(not set)'}"></td>
                                <td th:text="${submission.email != null ? submission.email : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: MARRIAGE INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-heart"></i> Marriage Information</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="maritalStatus"
                                           th:checked="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '') and submission.maritalStatus != null}"
                                           th:data-changed="${(currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '') != (submission.maritalStatus != null ? submission.maritalStatus : '')}"
                                           th:data-would-clear="${currentParishioner.maritalStatus != null and submission.maritalStatus == null}"
                                           th:data-field-name="'Marital Status'">
                                </td>
                                <td>Marital Status</td>
                                <td th:text="${currentParishioner.maritalStatus != null ? currentParishioner.maritalStatus : '(not set)'}"></td>
                                <td th:text="${submission.maritalStatus != null ? submission.maritalStatus : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.marriageDate != submission.marriageDate ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="marriageDate"
                                           th:checked="${currentParishioner.marriageDate != submission.marriageDate and submission.marriageDate != null}"
                                           th:data-changed="${currentParishioner.marriageDate != submission.marriageDate}"
                                           th:data-would-clear="${currentParishioner.marriageDate != null and submission.marriageDate == null}"
                                           th:data-field-name="'Marriage Date'">
                                </td>
                                <td>Marriage Date</td>
                                <td th:text="${currentParishioner.marriageDate != null ? #temporals.format(currentParishioner.marriageDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.marriageDate != null ? #temporals.format(submission.marriageDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: ORTHODOX INFORMATION -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-cross"></i> Orthodox Church Information</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="baptismalName"
                                           th:checked="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '') and (submission.baptismalName != null and !submission.baptismalName.isEmpty())}"
                                           th:data-changed="${(currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '') != (submission.baptismalName != null ? submission.baptismalName : '')}"
                                           th:data-would-clear="${(currentParishioner.baptismalName != null and !currentParishioner.baptismalName.isEmpty()) and (submission.baptismalName == null or submission.baptismalName.isEmpty())}"
                                           th:data-field-name="'Baptismal Name'">
                                </td>
                                <td>Baptismal Name</td>
                                <td th:text="${currentParishioner.baptismalName != null ? currentParishioner.baptismalName : '(not set)'}"></td>
                                <td th:text="${submission.baptismalName != null ? submission.baptismalName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="patronSaint"
                                           th:checked="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '') and (submission.patronSaint != null and !submission.patronSaint.isEmpty())}"
                                           th:data-changed="${(currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '') != (submission.patronSaint != null ? submission.patronSaint : '')}"
                                           th:data-would-clear="${(currentParishioner.patronSaint != null and !currentParishioner.patronSaint.isEmpty()) and (submission.patronSaint == null or submission.patronSaint.isEmpty())}"
                                           th:data-field-name="'Patron Saint'">
                                </td>
                                <td>Patron Saint</td>
                                <td th:text="${currentParishioner.patronSaint != null ? currentParishioner.patronSaint : '(not set)'}"></td>
                                <td th:text="${submission.patronSaint != null ? submission.patronSaint : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.baptismDate != submission.baptismDate ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="baptismDate"
                                           th:checked="${currentParishioner.baptismDate != submission.baptismDate and submission.baptismDate != null}"
                                           th:data-changed="${currentParishioner.baptismDate != submission.baptismDate}"
                                           th:data-would-clear="${currentParishioner.baptismDate != null and submission.baptismDate == null}"
                                           th:data-field-name="'Baptism Date'">
                                </td>
                                <td>Baptism Date</td>
                                <td th:text="${currentParishioner.baptismDate != null ? #temporals.format(currentParishioner.baptismDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.baptismDate != null ? #temporals.format(submission.baptismDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${currentParishioner.chrismationDate != submission.chrismationDate ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="chrismationDate"
                                           th:checked="${currentParishioner.chrismationDate != submission.chrismationDate and submission.chrismationDate != null}"
                                           th:data-changed="${currentParishioner.chrismationDate != submission.chrismationDate}"
                                           th:data-would-clear="${currentParishioner.chrismationDate != null and submission.chrismationDate == null}"
                                           th:data-field-name="'Chrismation Date'">
                                </td>
                                <td>Chrismation Date</td>
                                <td th:text="${currentParishioner.chrismationDate != null ? #temporals.format(currentParishioner.chrismationDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                                <td th:text="${submission.chrismationDate != null ? #temporals.format(submission.chrismationDate, 'MMMM dd, yyyy') : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: RELATIONSHIPS -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-people"></i> Relationships (Manual Entry)</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '') != (submission.manualGodfatherName != null ? submission.manualGodfatherName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualGodfatherName"
                                           th:checked="${(currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '') != (submission.manualGodfatherName != null ? submission.manualGodfatherName : '') and (submission.manualGodfatherName != null and !submission.manualGodfatherName.isEmpty())}"
                                           th:data-changed="${(currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '') != (submission.manualGodfatherName != null ? submission.manualGodfatherName : '')}"
                                           th:data-would-clear="${(currentParishioner.manualGodfatherName != null and !currentParishioner.manualGodfatherName.isEmpty()) and (submission.manualGodfatherName == null or submission.manualGodfatherName.isEmpty())}"
                                           th:data-field-name="'Godfather'">
                                </td>
                                <td>Godfather (Koumparos)</td>
                                <td th:text="${currentParishioner.manualGodfatherName != null ? currentParishioner.manualGodfatherName : '(not set)'}"></td>
                                <td th:text="${submission.manualGodfatherName != null ? submission.manualGodfatherName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '') != (submission.manualGodmotherName != null ? submission.manualGodmotherName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualGodmotherName"
                                           th:checked="${(currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '') != (submission.manualGodmotherName != null ? submission.manualGodmotherName : '') and (submission.manualGodmotherName != null and !submission.manualGodmotherName.isEmpty())}"
                                           th:data-changed="${(currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '') != (submission.manualGodmotherName != null ? submission.manualGodmotherName : '')}"
                                           th:data-would-clear="${(currentParishioner.manualGodmotherName != null and !currentParishioner.manualGodmotherName.isEmpty()) and (submission.manualGodmotherName == null or submission.manualGodmotherName.isEmpty())}"
                                           th:data-field-name="'Godmother'">
                                </td>
                                <td>Godmother (Koumpara)</td>
                                <td th:text="${currentParishioner.manualGodmotherName != null ? currentParishioner.manualGodmotherName : '(not set)'}"></td>
                                <td th:text="${submission.manualGodmotherName != null ? submission.manualGodmotherName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '') != (submission.manualSpouseName != null ? submission.manualSpouseName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualSpouseName"
                                           th:checked="${(currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '') != (submission.manualSpouseName != null ? submission.manualSpouseName : '') and (submission.manualSpouseName != null and !submission.manualSpouseName.isEmpty())}"
                                           th:data-changed="${(currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '') != (submission.manualSpouseName != null ? submission.manualSpouseName : '')}"
                                           th:data-would-clear="${(currentParishioner.manualSpouseName != null and !currentParishioner.manualSpouseName.isEmpty()) and (submission.manualSpouseName == null or submission.manualSpouseName.isEmpty())}"
                                           th:data-field-name="'Spouse Name'">
                                </td>
                                <td>Spouse Name (Manual)</td>
                                <td th:text="${currentParishioner.manualSpouseName != null ? currentParishioner.manualSpouseName : '(not set)'}"></td>
                                <td th:text="${submission.manualSpouseName != null ? submission.manualSpouseName : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '') != (submission.manualSponsorName != null ? submission.manualSponsorName : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="manualSponsorName"
                                           th:checked="${(currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '') != (submission.manualSponsorName != null ? submission.manualSponsorName : '') and (submission.manualSponsorName != null and !submission.manualSponsorName.isEmpty())}"
                                           th:data-changed="${(currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '') != (submission.manualSponsorName != null ? submission.manualSponsorName : '')}"
                                           th:data-would-clear="${(currentParishioner.manualSponsorName != null and !currentParishioner.manualSponsorName.isEmpty()) and (submission.manualSponsorName == null or submission.manualSponsorName.isEmpty())}"
                                           th:data-field-name="'Sponsor Name'">
                                </td>
                                <td>Sponsor Name</td>
                                <td th:text="${currentParishioner.manualSponsorName != null ? currentParishioner.manualSponsorName : '(not set)'}"></td>
                                <td th:text="${submission.manualSponsorName != null ? submission.manualSponsorName : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: HOUSEHOLD ADDRESS -->
                            <tr class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-house"></i> Household Address</td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.household != null and currentParishioner.household.address != null ? currentParishioner.household.address : '') != (submission.address != null ? submission.address : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="address"
                                           th:checked="${(currentParishioner.household != null and currentParishioner.household.address != null ? currentParishioner.household.address : '') != (submission.address != null ? submission.address : '') and (submission.address != null and !submission.address.isEmpty())}"
                                           th:data-changed="${(currentParishioner.household != null and currentParishioner.household.address != null ? currentParishioner.household.address : '') != (submission.address != null ? submission.address : '')}"
                                           th:data-would-clear="${(currentParishioner.household != null and currentParishioner.household.address != null and !currentParishioner.household.address.isEmpty()) and (submission.address == null or submission.address.isEmpty())}"
                                           th:data-field-name="'Street Address'">
                                </td>
                                <td>Street Address</td>
                                <td th:text="${currentParishioner.household != null and currentParishioner.household.address != null ? currentParishioner.household.address : '(not set)'}"></td>
                                <td th:text="${submission.address != null ? submission.address : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.household != null and currentParishioner.household.city != null ? currentParishioner.household.city : '') != (submission.city != null ? submission.city : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="city"
                                           th:checked="${(currentParishioner.household != null and currentParishioner.household.city != null ? currentParishioner.household.city : '') != (submission.city != null ? submission.city : '') and (submission.city != null and !submission.city.isEmpty())}"
                                           th:data-changed="${(currentParishioner.household != null and currentParishioner.household.city != null ? currentParishioner.household.city : '') != (submission.city != null ? submission.city : '')}"
                                           th:data-would-clear="${(currentParishioner.household != null and currentParishioner.household.city != null and !currentParishioner.household.city.isEmpty()) and (submission.city == null or submission.city.isEmpty())}"
                                           th:data-field-name="'City'">
                                </td>
                                <td>City</td>
                                <td th:text="${currentParishioner.household != null and currentParishioner.household.city != null ? currentParishioner.household.city : '(not set)'}"></td>
                                <td th:text="${submission.city != null ? submission.city : '(not set)'}"></td>
                            </tr>
                            <tr th:classappend="${(currentParishioner.household != null and currentParishioner.household.zipCode != null ? currentParishioner.household.zipCode : '') != (submission.zipCode != null ? submission.zipCode : '') ? 'table-warning' : ''}">
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input field-checkbox" name="fieldsToUpdate" value="zipCode"
                                           th:checked="${(currentParishioner.household != null and currentParishioner.household.zipCode != null ? currentParishioner.household.zipCode : '') != (submission.zipCode != null ? submission.zipCode : '') and (submission.zipCode != null and !submission.zipCode.isEmpty())}"
                                           th:data-changed="${(currentParishioner.household != null and currentParishioner.household.zipCode != null ? currentParishioner.household.zipCode : '') != (submission.zipCode != null ? submission.zipCode : '')}"
                                           th:data-would-clear="${(currentParishioner.household != null and currentParishioner.household.zipCode != null and !currentParishioner.household.zipCode.isEmpty()) and (submission.zipCode == null or submission.zipCode.isEmpty())}"
                                           th:data-field-name="'Zip Code'">
                                </td>
                                <td>Zip Code</td>
                                <td th:text="${currentParishioner.household != null and currentParishioner.household.zipCode != null ? currentParishioner.household.zipCode : '(not set)'}"></td>
                                <td th:text="${submission.zipCode != null ? submission.zipCode : '(not set)'}"></td>
                            </tr>

                            <!-- SECTION: CHILDREN (Display Only) -->
                            <tr th:if="${submission.childrenList != null and submission.childrenList.size() > 0}" class="table-dark">
                                <td colspan="4" class="fw-bold"><i class="bi bi-person-badge"></i> Children (Display Only)</td>
                            </tr>
                            <tr th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                                <td class="text-center text-muted">-</td>
                                <td>Children</td>
                                <td>-</td>
                                <td>
                                    <ul class="mb-0 ps-3">
                                        <li th:each="child : ${submission.childrenList}">
                                            <span th:text="${child.name}"></span>
                                            <span th:if="${child.birthday != null}" class="text-muted">
                                                (Born: <span th:text="${#temporals.format(child.birthday, 'MMM dd, yyyy')}"></span>)
                                            </span>
                                        </li>
                                    </ul>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <button type="submit" form="approveFormUpdate" class="btn btn-primary fw-bold">
                        <i class="bi bi-pencil-square"></i> Apply Selected Changes
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW SUBMISSION: FULL DATA DISPLAY -->
        <div th:unless="${isUpdate}" class="card bg-white border-dark mb-4">
            <div class="card-header bg-light text-dark fw-bold border-bottom border-dark">
                <i class="bi bi-file-earmark-text"></i> Submitted Information
            </div>
            <div class="card-body">
                <!-- BASIC INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Basic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">First Name:</span>
                            <span class="view-mode" th:text="${submission.firstName}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="firstName"
                                   th:value="${submission.firstName}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Last Name:</span>
                            <span class="view-mode" th:text="${submission.lastName}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="lastName"
                                   th:value="${submission.lastName}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Name Suffix:</span>
                            <span class="view-mode" th:text="${submission.nameSuffix != null ? submission.nameSuffix : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="nameSuffix"
                                   th:value="${submission.nameSuffix}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Birthday:</span>
                            <span class="view-mode" th:text="${submission.birthday != null ? #temporals.format(submission.birthday, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="birthday"
                                   th:value="${submission.birthday}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- CONTACT INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Contact Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Email:</span>
                            <span class="view-mode" th:text="${submission.email != null ? submission.email : '(not set)'}"></span>
                            <input type="email" class="edit-mode form-control form-control-sm" name="email"
                                   th:value="${submission.email}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Phone:</span>
                            <span class="view-mode" th:text="${submission.phoneNumber != null ? submission.phoneNumber : '(not set)'}"></span>
                            <input type="tel" class="edit-mode form-control form-control-sm" name="phoneNumber"
                                   th:value="${submission.phoneNumber}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- ADDRESS -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Address</h6>
                    <div class="row">
                        <div class="col-md-12 mb-2">
                            <span class="field-label">Street:</span>
                            <span class="view-mode" th:text="${submission.address != null ? submission.address : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="address"
                                   th:value="${submission.address}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">City:</span>
                            <span class="view-mode" th:text="${submission.city != null ? submission.city : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="city"
                                   th:value="${submission.city}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Zip Code:</span>
                            <span class="view-mode" th:text="${submission.zipCode != null ? submission.zipCode : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="zipCode"
                                   th:value="${submission.zipCode}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- MARITAL STATUS -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Marital Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Marital Status:</span>
                            <span class="view-mode" th:text="${submission.maritalStatus != null ? submission.maritalStatus : '(not set)'}"></span>
                            <select class="edit-mode form-control form-control-sm" name="maritalStatus" style="display:none;">
                                <option value="">-- Select --</option>
                                <option value="SINGLE">SINGLE</option>
                                <option value="MARRIED">MARRIED</option>
                                <option value="WIDOWED">WIDOWED</option>
                                <option value="DIVORCED">DIVORCED</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Marriage Date:</span>
                            <span class="view-mode" th:text="${submission.marriageDate != null ? #temporals.format(submission.marriageDate, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="marriageDate"
                                   th:value="${submission.marriageDate}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- WARNING: MARRIED STATUS WITHOUT SPOUSE ASSIGNMENT (UPDATE ONLY) -->
                <div th:if="${isUpdate and submission.maritalStatus != null and submission.maritalStatus == 'MARRIED'}" class="alert alert-warning border-warning mb-4" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-3" style="font-size: 1.25rem; margin-top: 2px;"></i>
                        <div>
                            <strong>Spouse Assignment Required</strong>
                            <p class="mb-2">This person is marked as married. You must assign a spouse to another parishioner in the system when approving this submission.</p>
                            <p class="mb-0">If the spouse is not yet in the system, you can <a href="/parishioners/add" target="_blank" class="fw-bold text-warning text-decoration-underline">add them as a member here</a>. Then come back and link them in the relationship assignment section.</p>
                        </div>
                    </div>
                </div>

                <!-- SPOUSE CREATION INFORMATION -->
                <div class="mb-4" th:if="${submission.spouseFirstName != null or submission.spouseLastName != null or submission.spouseEmail != null or submission.spousePhoneNumber != null}">
                    <h6 class="text-dark fw-bold mb-3">New Spouse Information (To Create)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2" th:if="${submission.spouseFirstName != null}">
                            <p><span class="field-label">Spouse First Name:</span> <span th:text="${submission.spouseFirstName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spouseLastName != null}">
                            <p><span class="field-label">Spouse Last Name:</span> <span th:text="${submission.spouseLastName}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spouseEmail != null}">
                            <p><span class="field-label">Spouse Email:</span> <span th:text="${submission.spouseEmail}"></span></p>
                        </div>
                        <div class="col-md-6 mb-2" th:if="${submission.spousePhoneNumber != null}">
                            <p><span class="field-label">Spouse Phone:</span> <span th:text="${submission.spousePhoneNumber}"></span></p>
                        </div>
                    </div>
                </div>

                <!-- ORTHODOX INFORMATION -->
                <div class="mb-4">
                    <h6 class="text-dark fw-bold mb-3">Orthodox Church Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Baptismal Name:</span>
                            <span class="view-mode" th:text="${submission.baptismalName != null ? submission.baptismalName : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="baptismalName"
                                   th:value="${submission.baptismalName}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Patron Saint:</span>
                            <span class="view-mode" th:text="${submission.patronSaint != null ? submission.patronSaint : '(not set)'}"></span>
                            <input type="text" class="edit-mode form-control form-control-sm" name="patronSaint"
                                   th:value="${submission.patronSaint}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Baptism Date:</span>
                            <span class="view-mode" th:text="${submission.baptismDate != null ? #temporals.format(submission.baptismDate, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="baptismDate"
                                   th:value="${submission.baptismDate}" style="display:none;">
                        </div>
                        <div class="col-md-6 mb-2">
                            <span class="field-label">Chrismation Date:</span>
                            <span class="view-mode" th:text="${submission.chrismationDate != null ? #temporals.format(submission.chrismationDate, 'MMMM dd, yyyy') : '(not set)'}"></span>
                            <input type="date" class="edit-mode form-control form-control-sm" name="chrismationDate"
                                   th:value="${submission.chrismationDate}" style="display:none;">
                        </div>
                    </div>
                </div>

                <!-- CHILDREN -->
                <div class="mb-4" th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                    <h6 class="text-dark fw-bold mb-3">Children</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr style="background-color: #f8f9fa; color: black; border-bottom: 2px solid #333;">
                                            <th>Child Name</th>
                                            <th>Birthday</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="child : ${submission.childrenList}">
                                            <td th:text="${child.name}"></td>
                                            <td th:text="${child.birthday != null ? #temporals.format(child.birthday, 'MMMM dd, yyyy') : 'Not provided'}"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RELATIONSHIP ASSIGNMENT (EDIT MODE) -->
                <div class="mb-4 edit-mode" style="display:none;">
                    <h6 class="text-dark fw-bold mb-3"><i class="bi bi-link-45deg"></i> Assign Relationships</h6>

                    <!-- Spouse -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Spouse to Existing Member</label>
                            <select id="spouseSelect" class="search-select" data-manual-target="manualSpouseName">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep as Manual Entry</label>
                            <input type="text" id="manualSpouseName" class="form-control manual-input"
                                   placeholder="Manual spouse name"
                                   data-select-target="spouseSelect">
                        </div>
                    </div>

                    <!-- Godfather -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Godfather to Member</label>
                            <select id="godfatherSelect" class="search-select" data-manual-target="manualGodfatherName">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep Manual</label>
                            <input type="text" id="manualGodfatherName" class="form-control manual-input"
                                   placeholder="Manual godfather name"
                                   data-select-target="godfatherSelect">
                        </div>
                    </div>

                    <!-- Godmother -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Link Godmother to Member</label>
                            <select id="godmotherSelect" class="search-select" data-manual-target="manualGodmotherName">
                                <option value="">-- Select Member --</option>
                                <option th:each="p : ${allParishioners}"
                                        th:value="${p.id}"
                                        th:text="${p.firstName + ' ' + p.lastName}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Keep Manual</label>
                            <input type="text" id="manualGodmotherName" class="form-control manual-input"
                                   placeholder="Manual godmother name"
                                   data-select-target="godmotherSelect">
                        </div>
                    </div>

                    <!-- Household -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-dark">Assign to Existing Household</label>
                            <select id="householdSelect" class="search-select">
                                <option value="">-- None / Create New --</option>
                                <option th:each="h : ${allHouseholds}"
                                        th:value="${h.id}"
                                        th:text="${h.familyName + ' Household (' + (h.address != null ? h.address : 'no address') + ')'}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-dark">OR Create New Household</label>
                            <input type="text" id="newHouseholdName" class="form-control"
                                   placeholder="Enter family name for new household">
                        </div>
                    </div>
                </div>

                <!-- CHILDREN LINKING/CREATION (EDIT MODE) -->
                <div class="mb-4 edit-mode" style="display:none;" th:if="${submission.childrenList != null and submission.childrenList.size() > 0}">
                    <h6 class="text-dark fw-bold mb-3"><i class="bi bi-people-fill"></i> Assign Children</h6>
                    <p class="text-muted">For each child, either link to an existing parishioner or mark for creation.</p>

                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead style="background-color: #f8f9fa; color: black; border-bottom: 2px solid #333;">
                                <tr>
                                    <th>Child Name (from submission)</th>
                                    <th>Birthday</th>
                                    <th>Link to Existing Member</th>
                                    <th>OR Create New</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="child, iterStat : ${submission.childrenList}">
                                    <td th:text="${child.name}"></td>
                                    <td th:text="${child.birthday != null ? #temporals.format(child.birthday, 'MMM dd, yyyy') : 'Not provided'}"></td>
                                    <td>
                                        <select th:name="|childLinkIds[${iterStat.index}]|" class="search-select-child form-control-sm" th:data-child-index="${iterStat.index}">
                                            <option value="">-- Select Member --</option>
                                            <option th:each="p : ${allParishioners}"
                                                    th:value="${p.id}"
                                                    th:text="${p.firstName + ' ' + p.lastName + (p.birthday != null ? ' (born ' + #temporals.format(p.birthday, 'yyyy') + ')' : '')}">
                                            </option>
                                        </select>
                                    </td>
                                    <td class="text-center">
                                        <input type="checkbox" th:name="|childCreateIndexes|" th:value="${iterStat.index}" class="form-check-input child-create-checkbox" th:data-child-index="${iterStat.index}" checked>
                                        <small class="text-muted d-block">Create as new</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- HIDDEN APPROVE FORM FOR UPDATE SUBMISSIONS -->
        <form id="approveFormUpdate" th:if="${isUpdate}" th:action="@{/submissions/review/{id}/approve(id=${submission.id})}" method="post" style="display: none;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <input type="hidden" id="approveUpdateTargetParishionerId" name="targetParishionerId" value="" />
            <!-- Edited field parameters -->
            <input type="hidden" id="editFirstName" name="firstName" value="" />
            <input type="hidden" id="editLastName" name="lastName" value="" />
            <input type="hidden" id="editNameSuffix" name="nameSuffix" value="" />
            <input type="hidden" id="editBirthday" name="birthday" value="" />
            <input type="hidden" id="editEmail" name="email" value="" />
            <input type="hidden" id="editPhoneNumber" name="phoneNumber" value="" />
            <input type="hidden" id="editAddress" name="address" value="" />
            <input type="hidden" id="editCity" name="city" value="" />
            <input type="hidden" id="editZipCode" name="zipCode" value="" />
            <input type="hidden" id="editMaritalStatus" name="maritalStatus" value="" />
            <input type="hidden" id="editMarriageDate" name="marriageDate" value="" />
            <input type="hidden" id="editBaptismalName" name="baptismalName" value="" />
            <input type="hidden" id="editPatronSaint" name="patronSaint" value="" />
            <input type="hidden" id="editBaptismDate" name="baptismDate" value="" />
            <input type="hidden" id="editChrismationDate" name="chrismationDate" value="" />
            <input type="hidden" id="editMembershipStatus" name="membershipStatus" value="" />
            <!-- Relationship parameters for UPDATE -->
            <input type="hidden" id="editSelectedSpouseId" name="selectedSpouseId" value="" />
            <input type="hidden" id="editManualSpouseName" name="manualSpouseName" value="" />
            <input type="hidden" id="editSelectedGodfatherId" name="selectedGodfatherId" value="" />
            <input type="hidden" id="editManualGodfatherName" name="manualGodfatherName" value="" />
            <input type="hidden" id="editSelectedGodmotherId" name="selectedGodmotherId" value="" />
            <input type="hidden" id="editManualGodmotherName" name="manualGodmotherName" value="" />
            <input type="hidden" id="editSelectedSponsorId" name="selectedSponsorId" value="" />
            <input type="hidden" id="editManualSponsorName" name="manualSponsorName" value="" />
            <input type="hidden" id="editSelectedHouseholdId" name="selectedHouseholdId" value="" />
            <input type="hidden" id="editSelectedNewHouseholdName" name="selectedNewHouseholdName" value="" />
            <!-- Children linking parameters will be added by JavaScript -->
            <div id="childrenParamsContainerUpdate"></div>
            <div id="fieldsToUpdateContainer"></div>
        </form>

        <!-- APPROVAL/REJECTION ACTIONS -->
        <div th:if="${submission.status.name() == 'PENDING'}" class="row">
            <!-- APPROVE BUTTON: ONLY FOR NEW SUBMISSIONS -->
            <div th:if="${!isUpdate}" class="col-md-6">
                <form id="approveForm" th:action="@{/submissions/review/{id}/approve(id=${submission.id})}" method="post" class="card bg-success border-0">
                    <div class="card-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="approveTargetParishionerId" name="targetParishionerId" value="" />
                        <!-- Edited field parameters -->
                        <input type="hidden" id="editFirstName" name="firstName" value="" />
                        <input type="hidden" id="editLastName" name="lastName" value="" />
                        <input type="hidden" id="editNameSuffix" name="nameSuffix" value="" />
                        <input type="hidden" id="editBirthday" name="birthday" value="" />
                        <input type="hidden" id="editEmail" name="email" value="" />
                        <input type="hidden" id="editPhoneNumber" name="phoneNumber" value="" />
                        <input type="hidden" id="editAddress" name="address" value="" />
                        <input type="hidden" id="editCity" name="city" value="" />
                        <input type="hidden" id="editZipCode" name="zipCode" value="" />
                        <input type="hidden" id="editMaritalStatus" name="maritalStatus" value="" />
                        <input type="hidden" id="editMarriageDate" name="marriageDate" value="" />
                        <input type="hidden" id="editBaptismalName" name="baptismalName" value="" />
                        <input type="hidden" id="editPatronSaint" name="patronSaint" value="" />
                        <input type="hidden" id="editBaptismDate" name="baptismDate" value="" />
                        <input type="hidden" id="editChrismationDate" name="chrismationDate" value="" />
                        <input type="hidden" id="editMembershipStatus" name="membershipStatus" value="" />
                        <!-- Relationship parameters -->
                        <input type="hidden" id="editSelectedSpouseId" name="selectedSpouseId" value="" />
                        <input type="hidden" id="editManualSpouseName" name="manualSpouseName" value="" />
                        <input type="hidden" id="editSelectedGodfatherId" name="selectedGodfatherId" value="" />
                        <input type="hidden" id="editManualGodfatherName" name="manualGodfatherName" value="" />
                        <input type="hidden" id="editSelectedGodmotherId" name="selectedGodmotherId" value="" />
                        <input type="hidden" id="editManualGodmotherName" name="manualGodmotherName" value="" />
                        <input type="hidden" id="editSelectedHouseholdId" name="selectedHouseholdId" value="" />
                        <input type="hidden" id="editSelectedNewHouseholdName" name="selectedNewHouseholdName" value="" />
                        <!-- Children linking parameters will be added by JavaScript -->
                        <div id="childrenParamsContainer"></div>
                        <button type="submit" class="btn btn-success w-100 fw-bold">
                            <i class="bi bi-check-circle"></i> Approve & Create
                        </button>
                    </div>
                </form>
            </div>
            <!-- REJECT BUTTON: FOR ALL SUBMISSION TYPES -->
            <div th:classappend="${!isUpdate ? 'col-md-6' : 'col-md-12'}">
                <form id="rejectForm" th:action="@{/submissions/review/{id}/reject(id=${submission.id})}" method="post" class="card bg-danger border-0">
                    <div class="card-body">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" id="rejectTargetParishionerId" name="targetParishionerId" value="" />
                        <textarea name="rejectionNotes" class="form-control form-control-sm mb-2" placeholder="Reason for rejection (optional)"></textarea>
                        <button type="submit" class="btn btn-danger w-100 fw-bold">
                            <i class="bi bi-x-circle"></i> Reject
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="mt-3">
            <a href="/submissions/review" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    <!-- MEMBERSHIP STATUS MODAL FOR NEW SUBMISSIONS -->
    <div class="modal fade" id="membershipStatusModal" tabindex="-1" th:if="${!isUpdate}">
        <div class="modal-dialog">
            <div class="modal-content bg-white">
                <div class="modal-header bg-light border-bottom border-dark">
                    <h5 class="modal-title text-dark fw-bold">Select Membership Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-dark mb-3">As a priest, please select the membership status for this new parishioner:</p>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="membershipStatusModal" id="membershipMEMBER" value="MEMBER" checked>
                        <label class="form-check-label text-dark" for="membershipMEMBER">
                            <strong>Member</strong> - Fully baptized and chrismated Orthodox member
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="membershipStatusModal" id="membershipCATECHUMEN" value="CATECHUMEN">
                        <label class="form-check-label text-dark" for="membershipCATECHUMEN">
                            <strong>Catechumen</strong> - Preparing for Baptism and Chrismation
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="membershipStatusModal" id="membershipVISITOR" value="VISITOR">
                        <label class="form-check-label text-dark" for="membershipVISITOR">
                            <strong>Visitor</strong> - Visiting or exploring the Orthodox Church
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="membershipStatusModal" id="membershipINACTIVE" value="INACTIVE">
                        <label class="form-check-label text-dark" for="membershipINACTIVE">
                            <strong>Inactive</strong> - No longer active in the parish
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmMembershipStatus">Confirm & Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SPOUSE ASSIGNMENT WARNING MODAL FOR NEW MARRIED SUBMISSIONS -->
    <div class="modal fade" id="spouseAssignmentModal" tabindex="-1" th:if="${!isUpdate}">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-white">
                <div class="modal-header bg-warning border-bottom border-dark">
                    <h5 class="modal-title text-dark fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Spouse Assignment Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-dark mb-3"><strong>This person is marked as married.</strong></p>
                    <p class="text-dark mb-3">You must provide spouse information when approving this submission.</p>

                    <p class="text-dark mb-3"><strong>You have two options:</strong></p>
                    <div class="ms-3 mb-3">
                        <p class="text-dark mb-2">
                            <strong>Option 1: Link to existing parishioner</strong><br>
                            <small class="text-muted">Select the spouse from the dropdown in the Assign Relationships section</small>
                        </p>
                        <p class="text-dark mb-0">
                            <strong>Option 2: Manual entry</strong><br>
                            <small class="text-muted">Enter the spouse's name manually if they're not yet in the system</small>
                        </p>
                    </div>

                    <div class="alert alert-info mb-3">
                        <strong>Spouse not in the system?</strong><br>
                        You can <a href="/parishioners/add" target="_blank" class="fw-bold text-decoration-underline">add them as a member here</a> (opens in a new tab). Then come back and link them. Or simply enter their name manually.
                    </div>

                    <p class="text-dark mb-0"><strong>Next Steps:</strong></p>
                    <ol class="text-dark">
                        <li>Click "Continue" below to proceed</li>
                        <li>Scroll down to the "Assign Relationships" section</li>
                        <li>Either:
                            <ul class="text-dark">
                                <li>Select spouse from dropdown, OR</li>
                                <li>Enter spouse name in "OR Keep as Manual Entry" field</li>
                            </ul>
                        </li>
                        <li>Click "Approve & Create" to complete</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmSpouseAssignment">Continue to Relationships</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const submissionId = window.location.pathname.split('/').pop();
        const approveForm = document.getElementById('approveForm');
        const rejectForm = document.getElementById('rejectForm');
        const targetParishionerSelect = document.getElementById('targetParishionerSelect');

        // Get CSRF token from meta tags or from hidden input in approve form
        function getCsrfToken() {
            const token = document.querySelector('meta[name="_csrf"]');
            if (token) return token.getAttribute('content');

            // Fallback: get from hidden input in any form
            const csrfInput = document.querySelector('input[name="_csrf"]');
            if (csrfInput) return csrfInput.value;

            return '';
        }

        function getCsrfHeader() {
            const header = document.querySelector('meta[name="_csrf_header"]');
            if (header) return header.getAttribute('content');
            return 'X-CSRF-TOKEN';
        }

        // When parishioner is selected, reload page with that parishioner loaded
        if (targetParishionerSelect) {
            targetParishionerSelect.addEventListener('change', function() {
                const selectedId = this.value;
                if (selectedId) {
                    // Reload page - the controller will load the selected parishioner
                    // We pass it via a hidden form submission that will load it
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/submissions/review/' + submissionId + '/load-parishioner';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'targetParishionerId';
                    input.value = selectedId;
                    form.appendChild(input);

                    // Add CSRF token
                    const csrfToken = getCsrfToken();
                    const csrfHeader = getCsrfHeader();
                    if (csrfToken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = csrfHeader === 'X-CSRF-TOKEN' ? '_csrf' : csrfHeader;
                        csrfInput.value = csrfToken;
                        form.appendChild(csrfInput);
                    }

                    document.body.appendChild(form);
                    form.submit();
                }
            });
        }

        // Field selection helper functions
        function selectAllFields() {
            document.querySelectorAll('.field-checkbox').forEach(cb => {
                cb.checked = true;
                // Show warning for fields that would clear data
                if (cb.getAttribute('data-would-clear') === 'true') {
                    showClearWarning(cb);
                }
            });
        }

        function selectChangedFields() {
            document.querySelectorAll('.field-checkbox').forEach(cb => {
                // Only check if changed AND submitted value is not empty (won't clear)
                const isChanged = cb.getAttribute('data-changed') === 'true';
                const wouldClear = cb.getAttribute('data-would-clear') === 'true';
                cb.checked = isChanged && !wouldClear;
            });
        }

        function deselectAllFields() {
            document.querySelectorAll('.field-checkbox').forEach(cb => {
                cb.checked = false;
                hideClearWarning(cb);
            });
        }

        // Show warning when checking a field that would clear existing data
        function showClearWarning(checkbox) {
            const row = checkbox.closest('tr');
            const fieldName = checkbox.getAttribute('data-field-name') || 'this field';

            // Check if warning already exists
            if (row.querySelector('.clear-warning')) return;

            const warningSpan = document.createElement('span');
            warningSpan.className = 'clear-warning badge bg-danger ms-2';
            warningSpan.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Will clear existing value!';
            warningSpan.title = 'The submitted value is empty. Applying this will remove the current value.';

            const fieldCell = row.querySelectorAll('td')[1];
            if (fieldCell) {
                fieldCell.appendChild(warningSpan);
            }
        }

        function hideClearWarning(checkbox) {
            const row = checkbox.closest('tr');
            const warning = row.querySelector('.clear-warning');
            if (warning) {
                warning.remove();
            }
        }

        // Add change listeners to all checkboxes for clear warning
        document.querySelectorAll('.field-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked && this.getAttribute('data-would-clear') === 'true') {
                    showClearWarning(this);
                } else {
                    hideClearWarning(this);
                }
            });
        });

        // Collect selected fields and add to form before submission
        function collectSelectedFields(form) {
            // Remove any existing fieldsToUpdate inputs
            form.querySelectorAll('input[name="fieldsToUpdate"]').forEach(el => el.remove());

            // Add checked fields
            document.querySelectorAll('.field-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'fieldsToUpdate';
                input.value = cb.value;
                form.appendChild(input);
            });
        }

        // Populate target parishioner ID and selected fields when forms are submitted
        if (approveForm && targetParishionerSelect) {
            approveForm.addEventListener('submit', function(e) {
                document.getElementById('approveTargetParishionerId').value = targetParishionerSelect.value;
                collectSelectedFields(approveForm);
            });
        } else if (approveForm) {
            // NEW submission: show membership status modal before approval
            approveForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const membershipModal = new bootstrap.Modal(document.getElementById('membershipStatusModal'));
                membershipModal.show();
            });

            // Handle membership status modal confirmation
            const confirmBtn = document.getElementById('confirmMembershipStatus');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    // Get selected membership status from modal
                    const selectedStatus = document.querySelector('input[name="membershipStatusModal"]:checked').value;

                    // Set the hidden field value
                    document.getElementById('editMembershipStatus').value = selectedStatus;

                    // Check if submitted marital status is MARRIED
                    let isMarried = false;
                    let hasSpouseInfo = false;

                    // Find the marital status field in the NEW submission form
                    const maritalStatusSpans = document.querySelectorAll('.view-mode');
                    for (let span of maritalStatusSpans) {
                        const fieldLabel = span.parentElement.querySelector('.field-label');
                        if (fieldLabel && fieldLabel.textContent.includes('Marital Status')) {
                            if (span.textContent.trim() === 'MARRIED') {
                                isMarried = true;
                            }
                            break;
                        }
                    }

                    // Check if spouse info has been provided in the relationship assignment section
                    if (isMarried) {
                        const spouseSelect = document.getElementById('spouseSelect');
                        const manualSpouseName = document.getElementById('manualSpouseName');

                        if ((spouseSelect && spouseSelect.value) || (manualSpouseName && manualSpouseName.value.trim())) {
                            hasSpouseInfo = true;
                        }
                    }

                    // Collect fields and close membership status modal
                    collectSelectedFields(approveForm);
                    const membershipModal = bootstrap.Modal.getInstance(document.getElementById('membershipStatusModal'));
                    membershipModal.hide();

                    // If married but no spouse info provided yet, show spouse assignment modal
                    if (isMarried && !hasSpouseInfo) {
                        const spouseModal = new bootstrap.Modal(document.getElementById('spouseAssignmentModal'));
                        spouseModal.show();
                    } else {
                        // Submit the form without triggering the submit event again
                        approveForm.removeEventListener('submit', arguments.callee);
                        approveForm.submit();
                    }
                });
            }

            // Handle spouse assignment modal confirmation
            const confirmSpouseBtn = document.getElementById('confirmSpouseAssignment');
            if (confirmSpouseBtn) {
                confirmSpouseBtn.addEventListener('click', function() {
                    // Hide spouse modal and scroll to relationships section
                    bootstrap.Modal.getInstance(document.getElementById('spouseAssignmentModal')).hide();

                    // Scroll to the relationship assignment section
                    const relationshipSection = document.querySelector('h6');
                    const sections = Array.from(document.querySelectorAll('h6')).find(h =>
                        h.textContent.includes('Assign Relationships') && h.parentElement.classList.contains('edit-mode')
                    );

                    if (sections) {
                        sections.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            }
        }

        // For UPDATE submissions: populate target parishioner ID and selected fields
        const approveFormUpdate = document.getElementById('approveFormUpdate');
        if (approveFormUpdate && targetParishionerSelect) {
            approveFormUpdate.addEventListener('submit', function(e) {
                document.getElementById('approveUpdateTargetParishionerId').value = targetParishionerSelect.value;
                collectSelectedFields(approveFormUpdate);

                // Also collect edited field values for UPDATE submissions
                const editableFields = {
                    'firstName': document.querySelector('input[name="firstName"].edit-mode'),
                    'lastName': document.querySelector('input[name="lastName"].edit-mode'),
                    'nameSuffix': document.querySelector('input[name="nameSuffix"].edit-mode'),
                    'birthday': document.querySelector('input[name="birthday"].edit-mode'),
                    'email': document.querySelector('input[name="email"].edit-mode'),
                    'phoneNumber': document.querySelector('input[name="phoneNumber"].edit-mode'),
                    'address': document.querySelector('input[name="address"].edit-mode'),
                    'city': document.querySelector('input[name="city"].edit-mode'),
                    'zipCode': document.querySelector('input[name="zipCode"].edit-mode'),
                    'maritalStatus': document.querySelector('select[name="maritalStatus"].edit-mode'),
                    'marriageDate': document.querySelector('input[name="marriageDate"].edit-mode'),
                    'baptismalName': document.querySelector('input[name="baptismalName"].edit-mode'),
                    'patronSaint': document.querySelector('input[name="patronSaint"].edit-mode'),
                    'baptismDate': document.querySelector('input[name="baptismDate"].edit-mode'),
                    'chrismationDate': document.querySelector('input[name="chrismationDate"].edit-mode'),
                    'membershipStatus': document.querySelector('select[name="membershipStatus"].edit-mode'),
                };

                // Populate hidden fields with edited values
                for (const [fieldName, fieldElement] of Object.entries(editableFields)) {
                    if (fieldElement) {
                        const hiddenId = 'edit' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                        const hiddenEl = document.getElementById(hiddenId);
                        if (hiddenEl) {
                            hiddenEl.value = fieldElement.value || '';
                        }
                    }
                }

                // Collect relationship data for UPDATE submission
                const spouseSelectUpdate = document.getElementById('spouseSelectUpdate');
                const manualSpouseNameUpdate = document.getElementById('manualSpouseNameUpdate');
                const godfatherSelectUpdate = document.getElementById('godfatherSelectUpdate');
                const manualGodfatherNameUpdate = document.getElementById('manualGodfatherNameUpdate');
                const godmotherSelectUpdate = document.getElementById('godmotherSelectUpdate');
                const manualGodmotherNameUpdate = document.getElementById('manualGodmotherNameUpdate');
                const sponsorSelectUpdate = document.getElementById('sponsorSelectUpdate');
                const manualSponsorNameUpdate = document.getElementById('manualSponsorNameUpdate');
                const householdSelectUpdate = document.getElementById('householdSelectUpdate');
                const newHouseholdNameUpdate = document.getElementById('newHouseholdNameUpdate');

                if (spouseSelectUpdate) document.getElementById('editSelectedSpouseId').value = spouseSelectUpdate.value || '';
                if (manualSpouseNameUpdate) document.getElementById('editManualSpouseName').value = manualSpouseNameUpdate.value || '';
                if (godfatherSelectUpdate) document.getElementById('editSelectedGodfatherId').value = godfatherSelectUpdate.value || '';
                if (manualGodfatherNameUpdate) document.getElementById('editManualGodfatherName').value = manualGodfatherNameUpdate.value || '';
                if (godmotherSelectUpdate) document.getElementById('editSelectedGodmotherId').value = godmotherSelectUpdate.value || '';
                if (manualGodmotherNameUpdate) document.getElementById('editManualGodmotherName').value = manualGodmotherNameUpdate.value || '';
                if (sponsorSelectUpdate) document.getElementById('editSelectedSponsorId').value = sponsorSelectUpdate.value || '';
                if (manualSponsorNameUpdate) document.getElementById('editManualSponsorName').value = manualSponsorNameUpdate.value || '';
                if (householdSelectUpdate) document.getElementById('editSelectedHouseholdId').value = householdSelectUpdate.value || '';
                if (newHouseholdNameUpdate) document.getElementById('editSelectedNewHouseholdName').value = newHouseholdNameUpdate.value || '';

                // Collect children linking/creation parameters for UPDATE
                const childrenContainerUpdate = document.getElementById('childrenParamsContainerUpdate');
                if (childrenContainerUpdate) {
                    childrenContainerUpdate.innerHTML = '';

                    // Collect childLinkIds
                    document.querySelectorAll('.search-select-child').forEach((select, idx) => {
                        if (select.value) {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'childLinkIds';
                            input.value = select.value;
                            childrenContainerUpdate.appendChild(input);
                        }
                    });

                    // Collect childCreateIndexes
                    document.querySelectorAll('.child-create-checkbox:checked').forEach((checkbox) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'childCreateIndexes';
                        input.value = checkbox.value;
                        childrenContainerUpdate.appendChild(input);
                    });
                }
            });
        }

        if (rejectForm && targetParishionerSelect) {
            rejectForm.addEventListener('submit', function() {
                document.getElementById('rejectTargetParishionerId').value = targetParishionerSelect.value;
            });
        }

        // ===== NEW: EDIT MODE & RELATIONSHIP ASSIGNMENT LOGIC =====

        // Edit mode toggle for NEW submissions
        let editModeActive = false;
        const editModeBtn = document.getElementById('toggleEditMode');
        editModeBtn?.addEventListener('click', function() {
            editModeActive = !editModeActive;

            if (editModeActive) {
                // Turn edit mode ON
                document.querySelectorAll('.edit-mode').forEach(el => el.style.display = '');
                document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
                this.innerHTML = '<i class="bi bi-check-circle"></i> Edit Mode Active - Click to Disable';
                this.classList.replace('btn-warning', 'btn-info');
            } else {
                // Turn edit mode OFF - update view-mode with edited values
                document.querySelectorAll('.edit-mode').forEach(editEl => {
                    // Find the corresponding view-mode span
                    const container = editEl.parentElement;
                    const viewModeSpan = container.querySelector('.view-mode');

                    if (viewModeSpan && editEl.value) {
                        // Update view-mode text with the edited value
                        if (editEl.tagName === 'INPUT' && editEl.type === 'date') {
                            // Format date for display
                            const date = new Date(editEl.value + 'T00:00:00');
                            const options = { year: 'numeric', month: 'long', day: 'numeric' };
                            viewModeSpan.textContent = date.toLocaleDateString('en-US', options);
                        } else if (editEl.tagName === 'SELECT') {
                            // For selects, show the selected option text or value
                            viewModeSpan.textContent = editEl.options[editEl.selectedIndex]?.text || editEl.value || '(not set)';
                        } else {
                            // For text inputs
                            viewModeSpan.textContent = editEl.value || '(not set)';
                        }
                    }
                    editEl.style.display = 'none';
                });

                document.querySelectorAll('.view-mode').forEach(el => el.style.display = '');
                this.innerHTML = '<i class="bi bi-pencil-square"></i> Enable Edit Mode';
                this.classList.replace('btn-info', 'btn-warning');
            }
        });

        // Edit mode toggle for UPDATE submissions
        let editModeActiveUpdate = false;
        const editModeBtnUpdate = document.getElementById('toggleEditModeUpdate');
        editModeBtnUpdate?.addEventListener('click', function() {
            editModeActiveUpdate = !editModeActiveUpdate;

            if (editModeActiveUpdate) {
                // Turn edit mode ON
                document.querySelectorAll('.edit-mode').forEach(el => el.style.display = '');
                document.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
                this.innerHTML = '<i class="bi bi-check-circle"></i> Edit Mode Active - Click to Disable';
                this.classList.replace('btn-warning', 'btn-info');
            } else {
                // Turn edit mode OFF - update view-mode with edited values
                document.querySelectorAll('.edit-mode').forEach(editEl => {
                    // Find the corresponding view-mode span
                    const container = editEl.parentElement;
                    const viewModeSpan = container.querySelector('.view-mode');

                    if (viewModeSpan && editEl.value) {
                        // Update view-mode text with the edited value
                        if (editEl.tagName === 'INPUT' && editEl.type === 'date') {
                            // Format date for display
                            const date = new Date(editEl.value + 'T00:00:00');
                            const options = { year: 'numeric', month: 'long', day: 'numeric' };
                            viewModeSpan.textContent = date.toLocaleDateString('en-US', options);
                        } else if (editEl.tagName === 'SELECT') {
                            // For selects, show the selected option text or value
                            viewModeSpan.textContent = editEl.options[editEl.selectedIndex]?.text || editEl.value || '(not set)';
                        } else {
                            // For text inputs
                            viewModeSpan.textContent = editEl.value || '(not set)';
                        }
                    }
                    editEl.style.display = 'none';
                });

                document.querySelectorAll('.view-mode').forEach(el => el.style.display = '');
                this.innerHTML = '<i class="bi bi-pencil-square"></i> Enable Edit Mode';
                this.classList.replace('btn-info', 'btn-warning');
            }
        });

        // Initialize TomSelect for relationships
        document.querySelectorAll('.search-select').forEach(el => {
            new TomSelect(el, {
                create: false,
                sortField: {field: "text", direction: "asc"},
                placeholder: "Search..."
            });
        });

        // Initialize TomSelect for children (needs different handling due to dynamic naming)
        document.querySelectorAll('.search-select-child').forEach(el => {
            new TomSelect(el, {
                create: false,
                sortField: {field: "text", direction: "asc"},
                placeholder: "Search members...",
                maxOptions: 200
            });
        });

        // Children mutual exclusion: clear checkbox when selecting from dropdown
        document.querySelectorAll('.search-select-child').forEach(select => {
            select.addEventListener('change', function() {
                if (this.value) {
                    const index = this.getAttribute('data-child-index');
                    const checkbox = document.querySelector(`.child-create-checkbox[data-child-index="${index}"]`);
                    if (checkbox) checkbox.checked = false;
                }
            });
        });

        // Clear dropdown when checking "create new" checkbox
        document.querySelectorAll('.child-create-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    const index = this.getAttribute('data-child-index');
                    const select = document.querySelector(`.search-select-child[data-child-index="${index}"]`);
                    if (select?.tomselect) select.tomselect.clear();
                }
            });
        });

        // Mutual exclusion: clear manual input when selecting dropdown
        document.querySelectorAll('.search-select').forEach(select => {
            select.addEventListener('change', function() {
                if (this.value) {
                    const manualId = this.getAttribute('data-manual-target');
                    if (manualId) document.getElementById(manualId).value = '';
                }
            });
        });

        // Clear dropdown when typing in manual input
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('input', function() {
                if (this.value.trim()) {
                    const selectId = this.getAttribute('data-select-target');
                    const selectEl = document.getElementById(selectId);
                    if (selectEl?.tomselect) selectEl.tomselect.clear();
                }
            });
        });

        // Household mutual exclusion (NEW submissions)
        const householdSelect = document.getElementById('householdSelect');
        const newHouseholdInput = document.getElementById('newHouseholdName');

        householdSelect?.addEventListener('change', function() {
            if (this.value) newHouseholdInput.value = '';
        });

        newHouseholdInput?.addEventListener('input', function() {
            if (this.value.trim() && householdSelect?.tomselect) {
                householdSelect.tomselect.clear();
            }
        });

        // Household mutual exclusion (UPDATE submissions)
        const householdSelectUpdate = document.getElementById('householdSelectUpdate');
        const newHouseholdInputUpdate = document.getElementById('newHouseholdNameUpdate');

        householdSelectUpdate?.addEventListener('change', function() {
            if (this.value) newHouseholdInputUpdate.value = '';
        });

        newHouseholdInputUpdate?.addEventListener('input', function() {
            if (this.value.trim() && householdSelectUpdate?.tomselect) {
                householdSelectUpdate.tomselect.clear();
            }
        });

        // Mutual exclusion for UPDATE submission relationships (spouse/godfather/godmother/sponsor)
        const updateRelationshipPairs = [
            { selectId: 'spouseSelectUpdate', manualId: 'manualSpouseNameUpdate' },
            { selectId: 'godfatherSelectUpdate', manualId: 'manualGodfatherNameUpdate' },
            { selectId: 'godmotherSelectUpdate', manualId: 'manualGodmotherNameUpdate' },
            { selectId: 'sponsorSelectUpdate', manualId: 'manualSponsorNameUpdate' }
        ];

        updateRelationshipPairs.forEach(pair => {
            const selectEl = document.getElementById(pair.selectId);
            const manualEl = document.getElementById(pair.manualId);

            selectEl?.addEventListener('change', function() {
                if (this.value) manualEl.value = '';
            });

            manualEl?.addEventListener('input', function() {
                if (this.value.trim() && selectEl?.tomselect) {
                    selectEl.tomselect.clear();
                }
            });
        });

        // Update comparison table when editing fields in UPDATE submission
        const editableFieldsForUpdate = {
            'firstName': 'First Name',
            'lastName': 'Last Name',
            'nameSuffix': 'Name Suffix',
            'birthday': 'Birthday',
            'email': 'Email',
            'phoneNumber': 'Phone',
            'address': 'Street',
            'city': 'City',
            'zipCode': 'Zip Code',
            'maritalStatus': 'Marital Status',
            'marriageDate': 'Marriage Date',
            'baptismalName': 'Baptismal Name',
            'patronSaint': 'Patron Saint',
            'baptismDate': 'Baptism Date',
            'chrismationDate': 'Chrismation Date'
        };

        // Monitor edit-mode inputs and update comparison table in real-time
        for (const [fieldName, displayName] of Object.entries(editableFieldsForUpdate)) {
            const editInput = document.querySelector(`input[name="${fieldName}"].edit-mode, select[name="${fieldName}"].edit-mode`);
            if (editInput) {
                editInput.addEventListener('input', function() {
                    updateComparisonTable(fieldName, this.value);
                });
                editInput.addEventListener('change', function() {
                    updateComparisonTable(fieldName, this.value);
                });
            }
        }

        function updateComparisonTable(fieldName, newValue) {
            // Find the row in the comparison table for this field
            const rows = document.querySelectorAll('.comparison-table tbody tr');
            for (const row of rows) {
                const checkbox = row.querySelector('input[name="fieldsToUpdate"]');
                if (checkbox && checkbox.value === fieldName) {
                    // Found the right row - update the 4th column (submitted value)
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 4) {
                        // Format the display value
                        let displayValue = newValue;

                        // Handle date fields
                        if ((fieldName === 'birthday' || fieldName === 'marriageDate' || fieldName === 'baptismDate' || fieldName === 'chrismationDate') && newValue) {
                            const dateObj = new Date(newValue + 'T00:00:00');
                            const options = { year: 'numeric', month: 'long', day: 'numeric' };
                            displayValue = dateObj.toLocaleDateString('en-US', options);
                        }

                        // Handle empty values
                        if (!displayValue || displayValue.trim() === '') {
                            displayValue = '(not set)';
                        }

                        cells[3].textContent = displayValue;
                    }
                    break;
                }
            }
        }

        // Collect relationship and children data when approving
        const approveFormElement = document.getElementById('approveForm');
        if (approveFormElement) {
            approveFormElement.addEventListener('submit', function(e) {
                // Collect edited field values from input elements
                const editableFields = {
                    'firstName': document.querySelector('input[name="firstName"].edit-mode'),
                    'lastName': document.querySelector('input[name="lastName"].edit-mode'),
                    'nameSuffix': document.querySelector('input[name="nameSuffix"].edit-mode'),
                    'birthday': document.querySelector('input[name="birthday"].edit-mode'),
                    'email': document.querySelector('input[name="email"].edit-mode'),
                    'phoneNumber': document.querySelector('input[name="phoneNumber"].edit-mode'),
                    'address': document.querySelector('input[name="address"].edit-mode'),
                    'city': document.querySelector('input[name="city"].edit-mode'),
                    'zipCode': document.querySelector('input[name="zipCode"].edit-mode'),
                    'maritalStatus': document.querySelector('select[name="maritalStatus"].edit-mode'),
                    'marriageDate': document.querySelector('input[name="marriageDate"].edit-mode'),
                    'baptismalName': document.querySelector('input[name="baptismalName"].edit-mode'),
                    'patronSaint': document.querySelector('input[name="patronSaint"].edit-mode'),
                    'baptismDate': document.querySelector('input[name="baptismDate"].edit-mode'),
                    'chrismationDate': document.querySelector('input[name="chrismationDate"].edit-mode'),
                    'membershipStatus': document.querySelector('select[name="membershipStatus"].edit-mode'),
                };

                // Populate hidden fields with edited values
                for (const [fieldName, fieldElement] of Object.entries(editableFields)) {
                    if (fieldElement) {
                        const hiddenId = 'edit' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                        const hiddenEl = document.getElementById(hiddenId);
                        if (hiddenEl) {
                            hiddenEl.value = fieldElement.value || '';
                        }
                    }
                }

                // Collect relationship data
                const spouseSelect = document.getElementById('spouseSelect');
                const manualSpouseName = document.getElementById('manualSpouseName');
                const godfatherSelect = document.getElementById('godfatherSelect');
                const manualGodfatherName = document.getElementById('manualGodfatherName');
                const godmotherSelect = document.getElementById('godmotherSelect');
                const manualGodmotherName = document.getElementById('manualGodmotherName');
                const householdSelect = document.getElementById('householdSelect');
                const newHouseholdName = document.getElementById('newHouseholdName');

                if (spouseSelect) document.getElementById('editSelectedSpouseId').value = spouseSelect.value || '';
                if (manualSpouseName) document.getElementById('editManualSpouseName').value = manualSpouseName.value || '';
                if (godfatherSelect) document.getElementById('editSelectedGodfatherId').value = godfatherSelect.value || '';
                if (manualGodfatherName) document.getElementById('editManualGodfatherName').value = manualGodfatherName.value || '';
                if (godmotherSelect) document.getElementById('editSelectedGodmotherId').value = godmotherSelect.value || '';
                if (manualGodmotherName) document.getElementById('editManualGodmotherName').value = manualGodmotherName.value || '';
                if (householdSelect) document.getElementById('editSelectedHouseholdId').value = householdSelect.value || '';
                if (newHouseholdName) document.getElementById('editSelectedNewHouseholdName').value = newHouseholdName.value || '';

                // Collect children linking/creation parameters
                const childrenContainer = document.getElementById('childrenParamsContainer');
                childrenContainer.innerHTML = '';

                // Collect childLinkIds
                document.querySelectorAll('.search-select-child').forEach((select, idx) => {
                    if (select.value) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'childLinkIds';
                        input.value = select.value;
                        childrenContainer.appendChild(input);
                    }
                });

                // Collect childCreateIndexes
                document.querySelectorAll('.child-create-checkbox:checked').forEach((checkbox) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'childCreateIndexes';
                    input.value = checkbox.value;
                    childrenContainer.appendChild(input);
                });
            });
        }
    </script>
</body>
</html>
